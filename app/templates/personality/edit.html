{% extends "base.html" %}

{% block title %}Edit {{ personality.name }} - MiaChat{% endblock %}

{% block content %}
<div class="bg-white shadow overflow-hidden sm:rounded-lg">
    <div class="px-4 py-5 sm:px-6">
        <h3 class="text-lg leading-6 font-medium text-gray-900">
            Edit Personality: {{ personality.name }}
        </h3>
        <p class="mt-1 max-w-2xl text-sm text-gray-500">
            Modify personality settings and attributes
        </p>
    </div>
    <div class="border-t border-gray-200 px-4 py-5 sm:px-6">
        <form action="{{ url_for('personality.edit_personality', id=personality.id) }}" method="POST" class="space-y-6">
            <!-- Basic Information -->
            <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700">Name</label>
                    <input type="text" name="name" id="name" value="{{ personality.name }}" required
                           class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="version" class="block text-sm font-medium text-gray-700">Version</label>
                    <input type="text" name="version" id="version" value="{{ personality.version }}" required
                           class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                </div>
            </div>

            <!-- Style Settings -->
            <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                <div>
                    <label for="tone" class="block text-sm font-medium text-gray-700">Tone</label>
                    <select name="tone" id="tone" required
                            class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option value="friendly" {% if personality.tone == 'friendly' %}selected{% endif %}>Friendly</option>
                        <option value="professional" {% if personality.tone == 'professional' %}selected{% endif %}>Professional</option>
                        <option value="casual" {% if personality.tone == 'casual' %}selected{% endif %}>Casual</option>
                        <option value="formal" {% if personality.tone == 'formal' %}selected{% endif %}>Formal</option>
                        <option value="humorous" {% if personality.tone == 'humorous' %}selected{% endif %}>Humorous</option>
                    </select>
                </div>
                <div>
                    <label for="vocabulary_level" class="block text-sm font-medium text-gray-700">Vocabulary Level (1-10)</label>
                    <input type="number" name="vocabulary_level" id="vocabulary_level" value="{{ personality.vocabulary_level }}" min="1" max="10" required
                           class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="formality" class="block text-sm font-medium text-gray-700">Formality Level (1-10)</label>
                    <input type="number" name="formality" id="formality" value="{{ personality.formality }}" min="1" max="10" required
                           class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="humor_level" class="block text-sm font-medium text-gray-700">Humor Level (1-10)</label>
                    <input type="number" name="humor_level" id="humor_level" value="{{ personality.humor_level }}" min="1" max="10" required
                           class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                </div>
            </div>

            <!-- Traits -->
            <div>
                <label class="block text-sm font-medium text-gray-700">Traits</label>
                <div class="mt-2 grid grid-cols-2 gap-2 sm:grid-cols-3 md:grid-cols-4">
                    {% for trait in ['Analytical', 'Creative', 'Empathetic', 'Logical', 'Witty', 'Serious', 'Playful', 'Professional'] %}
                    <div class="flex items-center">
                        <input type="checkbox" name="traits" value="{{ trait }}" id="trait_{{ trait|lower }}"
                               {% if trait in personality.traits|map(attribute='name')|list %}checked{% endif %}
                               class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                        <label for="trait_{{ trait|lower }}" class="ml-2 block text-sm text-gray-900">
                            {{ trait }}
                        </label>
                    </div>
                    {% endfor %}
                </div>
                <button id="suggest-traits-btn" type="button" class="btn btn-info mb-3">Suggest Traits</button>
                <span id="suggest-loading" style="display:none;">Suggesting...</span>
                <div id="suggest-error" class="text-danger" style="display:none;"></div>
            </div>

            <!-- Communication Style (Sliders) -->
            <div class="mt-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Communication Style</label>
                <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                    {% for style in ['Directness', 'Warmth', 'Formality', 'Empathy', 'Humor'] %}
                    <div>
                        <label for="comm_{{ style|lower }}" class="block text-xs font-medium text-gray-600">{{ style }}</label>
                        <input type="range" min="0" max="10" step="1" name="comm_{{ style|lower }}" id="comm_{{ style|lower }}" value="{{ personality.communication_style[style|lower] if personality.communication_style and style|lower in personality.communication_style else 5 }}" class="w-full">
                        <span id="comm_{{ style|lower }}_value" class="text-xs text-gray-500">{{ personality.communication_style[style|lower] if personality.communication_style and style|lower in personality.communication_style else 5 }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Knowledge Domains -->
            <div>
                <label class="block text-sm font-medium text-gray-700">Knowledge Domains</label>
                <div class="mt-2 grid grid-cols-2 gap-2 sm:grid-cols-3 md:grid-cols-4">
                    {% for domain in ['Science', 'Technology', 'Arts', 'History', 'Philosophy', 'Literature', 'Mathematics', 'Psychology'] %}
                    <div class="flex items-center">
                        <input type="checkbox" name="knowledge_domains" value="{{ domain }}" id="domain_{{ domain|lower }}"
                               {% if domain in personality.knowledge_domains|map(attribute='name')|list %}checked{% endif %}
                               class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                        <label for="domain_{{ domain|lower }}" class="ml-2 block text-sm text-gray-900">
                            {{ domain }}
                        </label>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Skills -->
            <div>
                <label class="block text-sm font-medium text-gray-700">Skills</label>
                <div class="mt-2 grid grid-cols-2 gap-2 sm:grid-cols-3 md:grid-cols-4">
                    {% for skill in ['Problem Solving', 'Communication', 'Analysis', 'Creativity', 'Teaching', 'Writing', 'Research', 'Critical Thinking'] %}
                    <div class="flex items-center">
                        <input type="checkbox" name="skills" value="{{ skill }}" id="skill_{{ skill|lower|replace(' ', '_') }}"
                               {% if skill in personality.skills|map(attribute='name')|list %}checked{% endif %}
                               class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                        <label for="skill_{{ skill|lower|replace(' ', '_') }}" class="ml-2 block text-sm text-gray-900">
                            {{ skill }}
                        </label>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Interests -->
            <div>
                <label class="block text-sm font-medium text-gray-700">Interests</label>
                <div class="mt-2 grid grid-cols-2 gap-2 sm:grid-cols-3 md:grid-cols-4">
                    {% for interest in ['Science', 'Technology', 'Arts', 'History', 'Philosophy', 'Literature', 'Mathematics', 'Psychology'] %}
                    <div class="flex items-center">
                        <input type="checkbox" name="interests" value="{{ interest }}" id="interest_{{ interest|lower }}"
                               {% if interest in personality.interests|map(attribute='name')|list %}checked{% endif %}
                               class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                        <label for="interest_{{ interest|lower }}" class="ml-2 block text-sm text-gray-900">
                            {{ interest }}
                        </label>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Backstory -->
            <div class="space-y-4">
                <div>
                    <label for="background" class="block text-sm font-medium text-gray-700">Background</label>
                    <textarea name="background" id="background" rows="3" required
                              class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">{{ personality.backstory.background }}</textarea>
                </div>
                <div>
                    <label for="experiences" class="block text-sm font-medium text-gray-700">Experiences</label>
                    <textarea name="experiences" id="experiences" rows="3" required
                              class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">{{ personality.backstory.experiences }}</textarea>
                </div>
                <div>
                    <label for="relationships" class="block text-sm font-medium text-gray-700">Relationships</label>
                    <textarea name="relationships" id="relationships" rows="3" required
                              class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">{{ personality.backstory.relationships }}</textarea>
                </div>
                <div>
                    <label for="goals" class="block text-sm font-medium text-gray-700">Goals</label>
                    <textarea name="goals" id="goals" rows="3" required
                              class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">{{ personality.backstory.goals }}</textarea>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="flex justify-end">
                <a href="{{ url_for('personality.list_personalities') }}"
                   class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Cancel
                </a>
                <button type="submit"
                        class="ml-3 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Save Changes
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.getElementById('suggest-traits-btn').addEventListener('click', async function() {
    const backstory = document.querySelector('[name="background"]').value;
    const name = document.querySelector('[name="name"]').value;
    const category = document.querySelector('[name="category"]').value;
    const loading = document.getElementById('suggest-loading');
    const errorDiv = document.getElementById('suggest-error');
    loading.style.display = 'inline';
    errorDiv.style.display = 'none';
    try {
        const res = await fetch('/api/suggest_traits', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ backstory, name, category })
        });
        const data = await res.json();
        if (data.traits) {
            // Update trait checkboxes/sliders
            for (const [trait, value] of Object.entries(data.traits)) {
                const slider = document.querySelector(`[name='traits'][data-trait='${trait}']`);
                if (slider) {
                    slider.value = value * 10;
                    // Optionally update label
                    const label = document.getElementById(`trait_value_${trait}`);
                    if (label) label.textContent = value.toFixed(2);
                }
                // If using checkboxes, check if value > 0.5
                const checkbox = document.getElementById(`trait_${trait.toLowerCase()}`);
                if (checkbox) checkbox.checked = value > 0.5;
            }
        }
        if (data.communication_style) {
            for (const [style, value] of Object.entries(data.communication_style)) {
                const slider = document.querySelector(`[name='comm_style'][data-style='${style}']`);
                if (slider) {
                    slider.value = value * 10;
                    const label = document.getElementById(`comm_value_${style}`);
                    if (label) label.textContent = value.toFixed(2);
                }
            }
        }
    } catch (err) {
        errorDiv.textContent = 'Failed to suggest traits. Please try again.';
        errorDiv.style.display = 'block';
    } finally {
        loading.style.display = 'none';
    }
});

// Add slider value display logic
['directness','warmth','formality','empathy','humor'].forEach(function(style) {
    var slider = document.getElementById('comm_' + style);
    var valueSpan = document.getElementById('comm_' + style + '_value');
    if (slider && valueSpan) {
        slider.addEventListener('input', function() {
            valueSpan.textContent = slider.value;
        });
    }
});
</script>
{% endblock %} 