<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if personality.name %}Edit {{ personality.name }}{% else %}Create Personality{% endif %} - MiaChat</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .form-range::-webkit-slider-thumb {
            background: #007bff;
        }
        .form-range::-moz-range-thumb {
            background: #007bff;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-3">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-robot"></i> MiaChat
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/chat">Chat</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/personality">Personalities</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/settings">Settings</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="mb-0">
                            <i class="fas fa-edit"></i> 
                            {% if personality.name %}Edit Personality: {{ personality.name }}{% else %}Create New Personality{% endif %}
                        </h3>
                    </div>
                    <div class="card-body">
                        <form id="personality-form" class="needs-validation" novalidate>
                            <!-- Basic Information -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="name" class="form-label">Name *</label>
                                    <input type="text" class="form-control" id="name" name="name" 
                                           value="{{ personality.name or '' }}" required>
                                    <div class="invalid-feedback">Please provide a name.</div>
                                </div>
                                <!-- Category Dropdown -->
                                <div class="col-md-6">
                                    <label for="category" class="form-label fw-bold">Category <span class="text-muted" style="font-weight:normal;">(e.g., Friend, Coach, Mentor, etc.)</span></label>
                                    <select class="form-select" id="category-select" name="category">
                                        <option value="Friend">Friend</option>
                                        <option value="Coach">Coach</option>
                                        <option value="Mentor">Mentor</option>
                                        <option value="Colleague">Colleague</option>
                                        <option value="Family">Family</option>
                                        <option value="Teacher">Teacher</option>
                                        <option value="Partner / Significant Other">Partner / Significant Other</option>
                                        <option value="Other">Other</option>
                                    </select>
                                    <input type="text" class="form-control mt-2" id="category-other" name="category_other" placeholder="Enter custom category" style="display:none;">
                                </div>
                            </div>

                            <!-- Personality -->
                            <div class="mb-3">
                                <label for="personality" class="form-label">Personality *</label>
                                <textarea class="form-control" id="personality" name="personality" rows="2" required>{{ personality.personality or '' }}</textarea>
                                <div class="invalid-feedback">Please provide a personality description.</div>
                                <small class="form-text text-muted">Brief description of the character's personality traits and behavior.</small>
                            </div>

                            <!-- Backstory -->
                            <div class="mb-3">
                                <label for="backstory" class="form-label">Backstory</label>
                                <textarea class="form-control" id="backstory" name="backstory" rows="4">{{ personality.backstory or '' }}</textarea>
                                <small class="form-text text-muted">Optional detailed backstory and history of the character.</small>
                            </div>

                            <!-- Traits -->
                            <div class="mb-3">
                                <div class="d-flex align-items-center mb-1">
                                    <label class="form-label fw-bold mb-0 me-2" style="font-size:1.1em;">Traits</label>
                                    <button id="suggest-traits-btn" type="button" class="btn btn-outline-info btn-sm ms-1" title="Let the AI analyze the backstory and suggest values for each trait.">
                                        <i class="fas fa-magic"></i> Have AI Suggest Traits
                                    </button>
                                </div>
                                <div id="traits-container" class="row"></div>
                                <span id="suggest-loading" class="ms-2" style="display:none;">
                                    <i class="fas fa-spinner fa-spin"></i> Suggesting...
                                </span>
                                <div id="suggest-summary" class="text-success mt-2" style="display:none;"></div>
                                <div id="suggest-error" class="text-danger mt-2" style="display:none;"></div>
                            </div>

                            <!-- Communication Style (Dynamic Sliders) -->
                            <div class="mb-3">
                                <label class="form-label fw-bold" style="font-size:1.1em;">Communication Style</label>
                                <div id="comm-style-container" class="row"></div>
                            </div>

                            <!-- System Prompt -->
                            <div class="mb-3">
                                <div class="d-flex align-items-center mb-1">
                                    <label for="system_prompt" class="form-label fw-bold mb-0 me-2" style="font-size:1.1em;">System Prompt</label>
                                    <button id="suggest-system-prompt-btn" type="button" class="btn btn-outline-info btn-sm ms-1" title="Let the AI generate a system prompt based on the backstory and category.">
                                        <i class="fas fa-magic"></i> Have AI Suggest Prompt
                                    </button>
                                </div>
                                <textarea class="form-control" id="system_prompt" name="system_prompt" rows="3" required>{{ personality.system_prompt or '' }}</textarea>
                                <div class="invalid-feedback">Please provide a system prompt.</div>
                                <span id="suggest-system-loading" class="text-muted" style="display:none;">
                                    <i class="fas fa-spinner fa-spin"></i> Generating system prompt...
                                </span>
                                <div id="suggest-system-error" class="text-danger mt-2" style="display:none;"></div>
                            </div>

                            <!-- Model Configuration -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="model" class="form-label">Model</label>
                                    <select class="form-select" id="model" name="model">
                                        <option value="llama3:8b" {% if personality.model_config and personality.model_config.model == 'llama3:8b' %}selected{% endif %}>llama3:8b (Local)</option>
                                        <option value="llama3.1:latest" {% if personality.model_config and personality.model_config.model == 'llama3.1:latest' %}selected{% endif %}>llama3.1:latest (Local)</option>
                                        <option value="mistral:latest" {% if personality.model_config and personality.model_config.model == 'mistral:latest' %}selected{% endif %}>mistral:latest (Local)</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="temperature" class="form-label">Temperature</label>
                                    <input type="range" class="form-range" min="0" max="2" step="0.1" 
                                           name="temperature" id="temperature" 
                                           value="{{ personality.model_config.temperature if personality.model_config and personality.model_config.temperature else 0.7 }}">
                                    <div class="d-flex justify-content-between">
                                        <small class="text-muted">0.0</small>
                                        <span id="temperature_value" class="text-muted">{{ personality.model_config.temperature if personality.model_config and personality.model_config.temperature else 0.7 }}</span>
                                        <small class="text-muted">2.0</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Submit Buttons -->
                            <div class="d-flex justify-content-between">
                                <a href="/personality" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left"></i> Cancel
                                </a>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> 
                                    {% if personality.name %}Save Changes{% else %}Create Personality{% endif %}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Healthcare Warning Modal -->
    <div class="modal fade" id="healthcareWarningModal" tabindex="-1" aria-labelledby="healthcareWarningLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="healthcareWarningLabel">Important Notice</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            This application is <b>not intended to provide medical, psychiatric, or therapeutic advice</b>. It cannot replace a licensed healthcare provider, therapist, or counselor. If you need professional help, please consult a qualified professional.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">OK</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Adult/Entertainment Warning Modal -->
    <div class="modal fade" id="adultWarningModal" tabindex="-1" aria-labelledby="adultWarningLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="adultWarningLabel">Adult Content Notice</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            This category may involve adult or entertainment content. Please acknowledge that you are over 18 and understand this is not a substitute for real relationships or professional advice.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="adultWarningAcknowledge" data-bs-dismiss="modal">I Understand</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- Fixed Traits and Communication Styles ---
        const FIXED_TRAITS = [
            'Empathy',
            'Assertiveness',
            'Adaptability',
            'Creativity',
            'Resilience',
            'Self-discipline',
            'Sociability',
            'Integrity',
            'Curiosity'
        ];
        const FIXED_COMM_STYLES = [
            'Directness',
            'Warmth',
            'Formality',
            'Assertiveness',
            'Empathy',
            'Humor'
        ];

        function renderFixedSliders(containerId, keys, data, prefix) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            keys.forEach(name => {
                const id = `${prefix}_${name.toLowerCase().replace(/\s+/g, '_')}`;
                const label = name.charAt(0).toUpperCase() + name.slice(1);
                const sliderValue = typeof data[name] === 'number' ? Math.round(data[name]) : 5;
                const col = document.createElement('div');
                col.className = 'col-md-6 mb-3';
                col.innerHTML = `
                    <label for="${id}" class="form-label">${label}</label>
                    <input type="range" class="form-range" min="0" max="10" step="1" name="${prefix}_${name}" id="${id}" value="${sliderValue}">
                    <div class="d-flex justify-content-between">
                        <small class="text-muted">0</small>
                        <span id="${id}_value" class="text-muted">${sliderValue}</span>
                        <small class="text-muted">10</small>
                    </div>
                `;
                container.appendChild(col);
                // Update value on input
                const slider = col.querySelector('input');
                const valueSpan = col.querySelector(`#${id}_value`);
                slider.addEventListener('input', function() {
                    valueSpan.textContent = slider.value;
                    // Hide AI suggestion summary if visible
                    const summary = document.getElementById('suggest-summary');
                    if (summary) summary.style.display = 'none';
                });
            });
        }

        // Load initial data from template context
        const initialTraits = JSON.parse('{{ (personality.traits or {}) | tojson | safe }}');
        const initialCommStyle = JSON.parse('{{ (personality.communication_style or {}) | tojson | safe }}');
        renderFixedSliders('traits-container', FIXED_TRAITS, initialTraits, 'trait');
        renderFixedSliders('comm-style-container', FIXED_COMM_STYLES, initialCommStyle, 'comm');

        // Suggest Traits functionality
        document.getElementById('suggest-traits-btn').addEventListener('click', async function() {
            const backstory = document.getElementById('backstory').value;
            const name = document.getElementById('name').value;
            const category = document.getElementById('category-select').value;
            const loading = document.getElementById('suggest-loading');
            const summary = document.getElementById('suggest-summary');
            const error = document.getElementById('suggest-error');
            loading.style.display = 'inline-block';
            summary.style.display = 'none';
            error.style.display = 'none';
            try {
                const resp = await fetch('/api/suggest_traits', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, category, backstory })
                });
                if (!resp.ok) throw new Error('Failed to get suggestions');
                const data = await resp.json();
                // Directly update trait sliders and labels
                Object.entries(data.traits).forEach(([trait, value]) => {
                    const id = `trait_${trait.toLowerCase().replace(/\s+/g, '_')}`;
                    const slider = document.getElementById(id);
                    const label = document.getElementById(`${id}_value`);
                    if (slider) {
                        slider.value = Math.round(value * 10);
                        if (label) label.textContent = Math.round(value * 10);
                    }
                });
                // Directly update communication style sliders and labels
                Object.entries(data.communication_style).forEach(([style, value]) => {
                    const id = `comm_${style.toLowerCase().replace(/\s+/g, '_')}`;
                    const slider = document.getElementById(id);
                    const label = document.getElementById(`${id}_value`);
                    if (slider) {
                        slider.value = Math.round(value * 10);
                        if (label) label.textContent = Math.round(value * 10);
                    }
                });
                // Show summary briefly
                summary.innerHTML = '<b>AI suggestions applied.</b>';
                summary.style.display = 'block';
                setTimeout(() => { summary.style.display = 'none'; }, 2000);
            } catch (e) {
                error.textContent = 'Error suggesting traits: ' + e.message;
                error.style.display = 'block';
            } finally {
                loading.style.display = 'none';
            }
        });

        // Suggest System Prompt functionality
        document.getElementById('suggest-system-prompt-btn').addEventListener('click', async function() {
            const backstory = document.getElementById('backstory').value;
            const category = document.getElementById('category-select').value;
            const systemPrompt = document.getElementById('system_prompt').value;
            const loading = document.getElementById('suggest-system-loading');
            const error = document.getElementById('suggest-system-error');
            loading.style.display = 'inline-block';
            error.style.display = 'none';

            try {
                const resp = await fetch('/api/suggest_system_prompt', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ backstory, category, system_prompt: systemPrompt })
                });
                if (!resp.ok) throw new Error('Failed to get system prompt suggestion');
                const data = await resp.json();
                document.getElementById('system_prompt').value = data.system_prompt;
            } catch (e) {
                error.textContent = 'Error suggesting system prompt: ' + e.message;
                error.style.display = 'block';
            } finally {
                loading.style.display = 'none';
            }
        });

        // JS for category dropdown and healthcare/adult warning
        const categorySelect = document.getElementById('category-select');
        const categoryOther = document.getElementById('category-other');
        const healthcareTerms = [
            'therapist', 'doctor', 'nurse', 'psychiatrist', 'counselor', 'psychologist', 'physician', 'clinician', 'medical', 'healthcare', 'shrink', 'psycho', 'medic', 'surgeon'
        ];
        let adultWarningAcknowledged = false;
        function checkHealthcareWarning(val) {
            if (!val) return false;
            const lower = val.toLowerCase();
            return healthcareTerms.some(term => lower.includes(term));
        }
        categorySelect.addEventListener('change', function() {
            if (this.value === 'Other') {
                categoryOther.style.display = '';
                categoryOther.required = true;
            } else {
                categoryOther.style.display = 'none';
                categoryOther.required = false;
            }
            // Adult/entertainment warning for Partner / Significant Other
            if (this.value === 'Partner / Significant Other') {
                if (!adultWarningAcknowledged) {
                    const modal = new bootstrap.Modal(document.getElementById('adultWarningModal'));
                    modal.show();
                }
            }
        });
        document.getElementById('adultWarningAcknowledge').addEventListener('click', function() {
            adultWarningAcknowledged = true;
        });
        categoryOther.addEventListener('input', function() {
            if (checkHealthcareWarning(this.value)) {
                const modal = new bootstrap.Modal(document.getElementById('healthcareWarningModal'));
                modal.show();
            }
        });
        // Form submission
        document.getElementById('personality-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!this.checkValidity()) {
                e.stopPropagation();
                this.classList.add('was-validated');
                return;
            }
            
            const formData = new FormData(this);
            
            // Collect fixed traits
            const traits = {};
            FIXED_TRAITS.forEach(name => {
                const slider = document.querySelector(`#trait_${name.toLowerCase().replace(/\s+/g, '_')}`);
                traits[name] = slider ? parseInt(slider.value) / 10 : 0.5;
            });
            
            // Collect fixed comm styles
            const communication_style = {};
            FIXED_COMM_STYLES.forEach(name => {
                const slider = document.querySelector(`#comm_${name.toLowerCase().replace(/\s+/g, '_')}`);
                communication_style[name] = slider ? parseInt(slider.value) / 10 : 0.5;
            });
            
            // Get the correct category value
            let categoryValue = categorySelect.value;
            if (categorySelect.value === 'Other') {
                categoryValue = categoryOther.value;
            }
            
            const personalityData = {
                name: formData.get('name'),
                personality: formData.get('personality'),
                category: categoryValue,
                backstory: formData.get('backstory'),
                system_prompt: formData.get('system_prompt'),
                traits: traits,
                communication_style: communication_style,
                llm_config: {
                    provider: 'ollama',
                    model: formData.get('model'),
                    temperature: parseFloat(formData.get('temperature'))
                }
            };
            
            try {
                const personalityId = '{{ personality.id or "" }}';
                const url = personalityId ? `/api/characters/${personalityId}` : '/api/characters';
                const method = personalityId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(personalityData)
                });
                
                if (response.ok) {
                    window.location.href = '/personality';
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.error || 'Failed to save personality'));
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        });
    </script>
</body>
</html> 