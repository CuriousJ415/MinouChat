{% extends "base.html" %}
{% set active_page = 'documents' %}

{% block title %}Documents - MinouChat{% endblock %}

{% block head %}
<style>
    .docs-header {
        padding: var(--space-8) 0;
        border-bottom: 1px solid var(--border-subtle);
        margin-bottom: var(--space-6);
    }

    .docs-title {
        font-size: var(--text-2xl);
        font-weight: var(--font-semibold);
        color: var(--text-primary);
        margin-bottom: var(--space-2);
    }

    .docs-subtitle {
        color: var(--text-muted);
        font-size: var(--text-sm);
    }

    /* Upload Area */
    .upload-zone {
        border: 2px dashed var(--border-color);
        border-radius: var(--radius-lg);
        padding: var(--space-8);
        text-align: center;
        cursor: pointer;
        transition: all var(--transition-fast);
        background: var(--bg-secondary);
    }

    .upload-zone:hover,
    .upload-zone.dragover {
        border-color: var(--text-primary);
        background: var(--bg-tertiary);
    }

    .upload-zone input[type="file"] {
        display: none;
    }

    .upload-icon {
        width: 48px;
        height: 48px;
        color: var(--text-muted);
        margin-bottom: var(--space-4);
    }

    .upload-title {
        font-size: var(--text-base);
        font-weight: var(--font-medium);
        color: var(--text-primary);
        margin-bottom: var(--space-2);
    }

    .upload-hint {
        font-size: var(--text-sm);
        color: var(--text-muted);
    }

    /* Progress */
    .upload-progress {
        display: none;
        margin-top: var(--space-4);
    }

    .upload-progress.show {
        display: block;
    }

    .progress-bar-container {
        height: 4px;
        background: var(--bg-tertiary);
        border-radius: var(--radius-full);
        overflow: hidden;
    }

    .progress-bar-fill {
        height: 100%;
        background: var(--text-primary);
        width: 0%;
        transition: width 0.3s ease;
    }

    .upload-status {
        margin-top: var(--space-3);
        font-size: var(--text-sm);
    }

    .upload-status .success {
        color: var(--pop-success);
    }

    .upload-status .error {
        color: var(--pop-danger);
    }

    .upload-status .info {
        color: var(--text-secondary);
    }

    /* Stats Cards */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: var(--space-4);
        margin-bottom: var(--space-6);
    }

    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }
    }

    .stat-card {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        padding: var(--space-4);
    }

    .stat-value {
        font-size: var(--text-xl);
        font-weight: var(--font-semibold);
        color: var(--text-primary);
    }

    .stat-label {
        font-size: var(--text-sm);
        color: var(--text-muted);
    }

    /* Search */
    .search-section {
        margin-bottom: var(--space-6);
    }

    .search-row {
        display: flex;
        gap: var(--space-3);
    }

    .search-row .form-input {
        flex: 1;
    }

    .search-results {
        margin-top: var(--space-4);
    }

    .search-result-item {
        padding: var(--space-4);
        border-left: 3px solid var(--text-primary);
        background: var(--bg-secondary);
        margin-bottom: var(--space-3);
        border-radius: 0 var(--radius-md) var(--radius-md) 0;
    }

    .search-result-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: var(--space-2);
    }

    .search-result-title {
        font-weight: var(--font-medium);
        color: var(--text-primary);
    }

    .similarity-badge {
        font-size: var(--text-xs);
        padding: 2px 8px;
        background: var(--text-primary);
        color: var(--bg-primary);
        border-radius: var(--radius-full);
    }

    .search-result-text {
        font-size: var(--text-sm);
        color: var(--text-secondary);
        margin-bottom: var(--space-2);
    }

    .search-result-meta {
        font-size: var(--text-xs);
        color: var(--text-muted);
    }

    /* Documents Table */
    .docs-section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-4);
    }

    .docs-section-title {
        font-size: var(--text-lg);
        font-weight: var(--font-semibold);
        color: var(--text-primary);
    }

    .docs-table {
        width: 100%;
        border-collapse: collapse;
    }

    .docs-table th {
        text-align: left;
        padding: var(--space-3) var(--space-4);
        font-size: var(--text-sm);
        font-weight: var(--font-medium);
        color: var(--text-muted);
        border-bottom: 1px solid var(--border-color);
    }

    .docs-table td {
        padding: var(--space-3) var(--space-4);
        font-size: var(--text-sm);
        color: var(--text-secondary);
        border-bottom: 1px solid var(--border-subtle);
    }

    .docs-table tr:hover td {
        background: var(--bg-secondary);
    }

    .doc-name {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        color: var(--text-primary);
        font-weight: var(--font-medium);
    }

    .doc-name svg {
        width: 16px;
        height: 16px;
        color: var(--text-muted);
    }

    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
        margin-right: var(--space-2);
    }

    .status-dot.completed {
        background: var(--pop-success);
    }

    .status-dot.processing {
        background: var(--pop-warning);
    }

    .status-dot.pending {
        background: var(--text-muted);
    }

    .status-dot.failed {
        background: var(--pop-danger);
    }

    .persona-chips {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-1);
    }

    .persona-chip {
        font-size: var(--text-xs);
        padding: 2px 8px;
        background: var(--bg-tertiary);
        border-radius: var(--radius-full);
        color: var(--text-secondary);
    }

    .doc-actions {
        display: flex;
        gap: var(--space-2);
    }

    .doc-actions button {
        padding: var(--space-1) var(--space-2);
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: var(--space-12);
    }

    .empty-state svg {
        width: 64px;
        height: 64px;
        color: var(--text-muted);
        margin-bottom: var(--space-4);
    }

    .empty-state-title {
        font-size: var(--text-lg);
        font-weight: var(--font-medium);
        color: var(--text-primary);
        margin-bottom: var(--space-2);
    }

    .empty-state-text {
        color: var(--text-muted);
        font-size: var(--text-sm);
    }

    /* Modal Styles */
    .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: var(--z-modal);
        opacity: 0;
        visibility: hidden;
        transition: all var(--transition-normal);
    }

    .modal-backdrop.show {
        opacity: 1;
        visibility: visible;
    }

    .modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.95);
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        z-index: var(--z-modal);
        opacity: 0;
        visibility: hidden;
        transition: all var(--transition-normal);
    }

    .modal.show {
        opacity: 1;
        visibility: visible;
        transform: translate(-50%, -50%) scale(1);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-4) var(--space-6);
        border-bottom: 1px solid var(--border-subtle);
    }

    .modal-title {
        font-size: var(--text-lg);
        font-weight: var(--font-semibold);
        color: var(--text-primary);
    }

    .modal-close {
        background: none;
        border: none;
        padding: var(--space-1);
        cursor: pointer;
        color: var(--text-muted);
        transition: color var(--transition-fast);
    }

    .modal-close:hover {
        color: var(--text-primary);
    }

    .modal-close svg {
        width: 20px;
        height: 20px;
    }

    .modal-body {
        padding: var(--space-6);
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: var(--space-3);
        padding: var(--space-4) var(--space-6);
        border-top: 1px solid var(--border-subtle);
    }

    /* Content Preview */
    .content-preview {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        padding: var(--space-4);
        max-height: 400px;
        overflow-y: auto;
        font-family: var(--font-mono);
        font-size: var(--text-sm);
        white-space: pre-wrap;
        word-break: break-word;
    }

    /* Checkbox List */
    .checkbox-list {
        display: flex;
        flex-direction: column;
        gap: var(--space-3);
    }

    .checkbox-item {
        display: flex;
        align-items: center;
        gap: var(--space-3);
    }

    .checkbox-item input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: var(--text-primary);
    }

    .checkbox-label {
        font-size: var(--text-sm);
        color: var(--text-primary);
    }

    /* Loading */
    .loading-indicator {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-2);
        padding: var(--space-8);
        color: var(--text-muted);
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .spinner {
        width: 20px;
        height: 20px;
        border: 2px solid var(--border-color);
        border-top-color: var(--text-primary);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    /* Toast Notifications */
    .toast-container {
        position: fixed;
        bottom: var(--space-6);
        right: var(--space-6);
        z-index: calc(var(--z-modal) + 10);
        display: flex;
        flex-direction: column;
        gap: var(--space-2);
    }

    .toast {
        display: flex;
        align-items: center;
        gap: var(--space-3);
        padding: var(--space-3) var(--space-4);
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        min-width: 280px;
        max-width: 400px;
        animation: slideIn 0.3s ease;
    }

    .toast.success {
        border-left: 3px solid var(--pop-success);
    }

    .toast.error {
        border-left: 3px solid var(--pop-danger);
    }

    .toast.info {
        border-left: 3px solid var(--pop-primary);
    }

    .toast-icon {
        width: 18px;
        height: 18px;
        flex-shrink: 0;
    }

    .toast.success .toast-icon { color: var(--pop-success); }
    .toast.error .toast-icon { color: var(--pop-danger); }
    .toast.info .toast-icon { color: var(--pop-primary); }

    .toast-message {
        flex: 1;
        font-size: var(--text-sm);
        color: var(--text-primary);
    }

    .toast-close {
        background: none;
        border: none;
        padding: var(--space-1);
        cursor: pointer;
        color: var(--text-muted);
        transition: color var(--transition-fast);
    }

    .toast-close:hover {
        color: var(--text-primary);
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }

    /* Upload Queue */
    .upload-queue {
        margin-top: var(--space-4);
        display: none;
    }

    .upload-queue.show {
        display: block;
    }

    .upload-queue-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-3);
    }

    .upload-queue-title {
        font-size: var(--text-sm);
        font-weight: var(--font-medium);
        color: var(--text-primary);
    }

    .upload-queue-actions {
        display: flex;
        gap: var(--space-2);
    }

    .upload-item {
        display: flex;
        align-items: center;
        gap: var(--space-3);
        padding: var(--space-3);
        background: var(--bg-secondary);
        border-radius: var(--radius-md);
        margin-bottom: var(--space-2);
    }

    .upload-item-icon {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--bg-tertiary);
        border-radius: var(--radius-sm);
        color: var(--text-muted);
    }

    .upload-item-icon svg {
        width: 18px;
        height: 18px;
    }

    .upload-item-info {
        flex: 1;
        min-width: 0;
    }

    .upload-item-name {
        font-size: var(--text-sm);
        font-weight: var(--font-medium);
        color: var(--text-primary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .upload-item-meta {
        font-size: var(--text-xs);
        color: var(--text-muted);
    }

    .upload-item-progress {
        width: 100px;
        height: 4px;
        background: var(--bg-tertiary);
        border-radius: var(--radius-full);
        overflow: hidden;
    }

    .upload-item-progress-fill {
        height: 100%;
        background: var(--pop-primary);
        transition: width 0.3s ease;
    }

    .upload-item-status {
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .upload-item-status.pending { color: var(--text-muted); }
    .upload-item-status.uploading { color: var(--pop-primary); }
    .upload-item-status.success { color: var(--pop-success); }
    .upload-item-status.error { color: var(--pop-danger); }

    .upload-item-cancel {
        background: none;
        border: none;
        padding: var(--space-1);
        cursor: pointer;
        color: var(--text-muted);
        transition: color var(--transition-fast);
    }

    .upload-item-cancel:hover {
        color: var(--pop-danger);
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
        .docs-header {
            padding: var(--space-4) 0;
        }

        .docs-title {
            font-size: var(--text-xl);
        }

        .docs-subtitle {
            font-size: var(--text-sm);
        }

        .docs-table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .docs-table {
            min-width: 600px;
        }

        .search-row {
            flex-direction: column;
            gap: var(--space-3);
        }

        .search-row .form-input {
            min-height: 44px;
            font-size: 16px;
        }

        .upload-zone {
            padding: var(--space-6);
        }

        .upload-zone svg {
            width: 32px;
            height: 32px;
        }

        .action-btn {
            min-width: 44px;
            min-height: 44px;
            padding: var(--space-3);
        }

        .modal {
            width: calc(100% - var(--space-4));
            max-width: none;
            max-height: calc(100vh - var(--space-8));
        }
    }

    /* Very small screens - use card layout instead of table */
    @media (max-width: 480px) {
        .docs-table-container {
            display: none;
        }

        .docs-card-list {
            display: block;
        }

        .doc-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--space-4);
            margin-bottom: var(--space-3);
        }

        .doc-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-3);
        }

        .doc-card-name {
            font-weight: var(--font-medium);
            word-break: break-word;
        }

        .doc-card-meta {
            display: flex;
            gap: var(--space-4);
            color: var(--text-muted);
            font-size: var(--text-sm);
            margin-bottom: var(--space-3);
        }

        .doc-card-actions {
            display: flex;
            gap: var(--space-2);
            justify-content: flex-end;
        }
    }

    @media (min-width: 481px) {
        .docs-card-list {
            display: none;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container" style="max-width: 1200px; margin: 0 auto; padding: 0 var(--space-4);">
    <!-- Header -->
    <div class="docs-header">
        <h1 class="docs-title">Documents</h1>
        <p class="docs-subtitle">Upload and manage documents for context-aware AI conversations</p>
    </div>

    <!-- Stats -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value" id="totalDocs">0</div>
            <div class="stat-label">Total Documents</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="processedDocs">0</div>
            <div class="stat-label">Processed</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="totalSize">0 MB</div>
            <div class="stat-label">Total Size</div>
        </div>
    </div>

    <!-- Upload Section -->
    <div class="card" style="margin-bottom: var(--space-6);">
        <div class="upload-zone" id="uploadArea">
            <input type="file" id="fileInput" multiple accept=".pdf,.docx,.doc,.txt,.md,.xlsx,.xls,.csv">
            <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
            </svg>
            <div class="upload-title">Drop files here or click to upload</div>
            <div class="upload-hint">PDF, Word, Excel, Text, Markdown, CSV - Max 50MB per file</div>
        </div>
        <!-- Upload Queue -->
        <div class="upload-queue" id="uploadQueue">
            <div class="upload-queue-header">
                <span class="upload-queue-title">Upload Queue</span>
                <div class="upload-queue-actions">
                    <button class="btn btn-ghost btn-sm" onclick="clearCompletedUploads()" title="Clear completed">
                        <i data-lucide="check-circle" style="width: 14px; height: 14px;"></i>
                        Clear Done
                    </button>
                    <button class="btn btn-ghost btn-sm" onclick="cancelAllUploads()" title="Cancel all">
                        <i data-lucide="x-circle" style="width: 14px; height: 14px;"></i>
                        Cancel All
                    </button>
                </div>
            </div>
            <div id="uploadQueueItems"></div>
        </div>
    </div>

    <!-- Search Section -->
    <div class="search-section">
        <div class="search-row">
            <input type="text" class="form-input" id="searchQuery" placeholder="Search your documents...">
            <button class="btn btn-primary" onclick="searchDocuments()">
                <i data-lucide="search" style="width: 16px; height: 16px;"></i>
                Search
            </button>
        </div>
        <div class="search-results" id="searchResults"></div>
    </div>

    <!-- Documents List -->
    <div class="docs-section">
        <div class="docs-section-header">
            <h2 class="docs-section-title">Your Documents</h2>
            <button class="btn btn-ghost" onclick="loadDocuments()">
                <i data-lucide="refresh-cw" style="width: 16px; height: 16px;"></i>
                Refresh
            </button>
        </div>

        <div class="card">
            <div class="docs-table-container">
                <table class="docs-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Size</th>
                            <th>Uploaded</th>
                            <th>Status</th>
                            <th>Personas</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="documentsContainer">
                        <tr>
                            <td colspan="6">
                                <div class="loading-indicator">
                                    <div class="spinner"></div>
                                    <span>Loading documents...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Content View Modal -->
<div class="modal-backdrop" id="contentModalBackdrop"></div>
<div class="modal" id="contentModal">
    <div class="modal-header">
        <h3 class="modal-title" id="contentModalTitle">Document Content</h3>
        <button class="modal-close" onclick="closeContentModal()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M18 6L6 18M6 6l12 12"/>
            </svg>
        </button>
    </div>
    <div class="modal-body">
        <pre class="content-preview" id="contentPreview"></pre>
    </div>
</div>

<!-- Assignment Modal -->
<div class="modal-backdrop" id="assignmentModalBackdrop"></div>
<div class="modal" id="assignmentModal">
    <div class="modal-header">
        <h3 class="modal-title">Manage Persona Assignments</h3>
        <button class="modal-close" onclick="closeAssignmentModal()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M18 6L6 18M6 6l12 12"/>
            </svg>
        </button>
    </div>
    <div class="modal-body">
        <p class="text-sm text-muted mb-4" id="assignmentDocName">Select which personas should have access to this document:</p>
        <div class="checkbox-list" id="characterCheckboxes">
            <div class="loading-indicator">
                <div class="spinner"></div>
                <span>Loading personas...</span>
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeAssignmentModal()">Cancel</button>
        <button class="btn btn-primary" id="saveAssignmentsBtn" onclick="saveAssignments()">Save Changes</button>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-backdrop" id="deleteModalBackdrop"></div>
<div class="modal" id="deleteModal" style="max-width: 400px;">
    <div class="modal-header">
        <h3 class="modal-title">Delete Document</h3>
        <button class="modal-close" onclick="closeDeleteModal()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M18 6L6 18M6 6l12 12"/>
            </svg>
        </button>
    </div>
    <div class="modal-body">
        <p>Are you sure you want to delete this document? This action cannot be undone.</p>
        <p class="text-sm text-muted mt-2" id="deleteDocName"></p>
    </div>
    <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
        <button class="btn btn-pop" style="background: var(--pop-danger);" onclick="confirmDelete()">Delete</button>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>
{% endblock %}

{% block scripts %}
<script>
    // Global variables
    let documents = [];
    let characters = [];
    let currentAssignmentDocId = null;
    let currentDeleteDocId = null;
    let uploadQueue = [];
    let uploadControllers = new Map();
    const MAX_FILE_SIZE = 50 * 1024 * 1024; // 50MB
    const SUPPORTED_TYPES = ['.pdf', '.docx', '.doc', '.txt', '.md', '.xlsx', '.xls', '.csv'];

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        loadCharacters();
        loadDocuments();
        refreshStats();
        setupUpload();
        lucide.createIcons();
    });

    // Toast notification system
    function showToast(message, type = 'info', duration = 4000) {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;

        const icons = {
            success: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
            error: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
            info: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>'
        };

        toast.innerHTML = `
            <span class="toast-icon">${icons[type] || icons.info}</span>
            <span class="toast-message">${message}</span>
            <button class="toast-close" onclick="this.parentElement.remove()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M18 6L6 18M6 6l12 12"/></svg>
            </button>
        `;

        container.appendChild(toast);

        // Auto-remove after duration
        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease forwards';
            setTimeout(() => toast.remove(), 300);
        }, duration);
    }

    // Setup file upload with improved drag-drop
    function setupUpload() {
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('click', () => fileInput.click());

        // Improved drag-drop handling
        let dragCounter = 0;

        uploadArea.addEventListener('dragenter', (e) => {
            e.preventDefault();
            dragCounter++;
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
        });

        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dragCounter--;
            if (dragCounter === 0) {
                uploadArea.classList.remove('dragover');
            }
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dragCounter = 0;
            uploadArea.classList.remove('dragover');
            handleFileSelection(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFileSelection(e.target.files);
            fileInput.value = ''; // Reset to allow re-selecting same file
        });
    }

    // Validate and queue files
    function handleFileSelection(files) {
        if (files.length === 0) return;

        const validFiles = [];
        const errors = [];

        for (const file of files) {
            // Check file size
            if (file.size > MAX_FILE_SIZE) {
                errors.push(`${file.name}: File too large (max 50MB)`);
                continue;
            }

            // Check file type
            const ext = '.' + file.name.split('.').pop().toLowerCase();
            if (!SUPPORTED_TYPES.includes(ext)) {
                errors.push(`${file.name}: Unsupported file type`);
                continue;
            }

            validFiles.push(file);
        }

        // Show errors for invalid files
        errors.forEach(err => showToast(err, 'error'));

        // Add valid files to queue
        if (validFiles.length > 0) {
            addToUploadQueue(validFiles);
        }
    }

    // Add files to upload queue
    function addToUploadQueue(files) {
        const queueContainer = document.getElementById('uploadQueue');
        const queueItems = document.getElementById('uploadQueueItems');

        files.forEach(file => {
            const id = 'upload-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            const item = {
                id,
                file,
                status: 'pending',
                progress: 0
            };
            uploadQueue.push(item);
            renderUploadItem(item);
        });

        queueContainer.classList.add('show');
        processUploadQueue();
    }

    // Render single upload item
    function renderUploadItem(item) {
        const queueItems = document.getElementById('uploadQueueItems');
        const existing = document.getElementById(item.id);

        const statusIcons = {
            pending: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
            uploading: '<div class="spinner" style="width:18px;height:18px;"></div>',
            success: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
            error: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>'
        };

        const html = `
            <div class="upload-item" id="${item.id}">
                <div class="upload-item-icon">
                    ${getFileIcon(item.file.name.split('.').pop().toLowerCase())}
                </div>
                <div class="upload-item-info">
                    <div class="upload-item-name" title="${item.file.name}">${item.file.name}</div>
                    <div class="upload-item-meta">${formatFileSize(item.file.size)}${item.error ? ' - ' + item.error : ''}</div>
                </div>
                <div class="upload-item-progress" style="display: ${item.status === 'uploading' ? 'block' : 'none'}">
                    <div class="upload-item-progress-fill" style="width: ${item.progress}%"></div>
                </div>
                <div class="upload-item-status ${item.status}">
                    ${statusIcons[item.status]}
                </div>
                ${item.status === 'pending' || item.status === 'uploading' ? `
                    <button class="upload-item-cancel" onclick="cancelUpload('${item.id}')" title="Cancel">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;">
                            <path d="M18 6L6 18M6 6l12 12"/>
                        </svg>
                    </button>
                ` : ''}
            </div>
        `;

        if (existing) {
            existing.outerHTML = html;
        } else {
            queueItems.insertAdjacentHTML('beforeend', html);
        }
    }

    // Process upload queue
    async function processUploadQueue() {
        const pendingItems = uploadQueue.filter(item => item.status === 'pending');
        const uploadingCount = uploadQueue.filter(item => item.status === 'uploading').length;

        // Process up to 2 concurrent uploads
        const maxConcurrent = 2;
        const toStart = pendingItems.slice(0, maxConcurrent - uploadingCount);

        for (const item of toStart) {
            uploadFile(item);
        }
    }

    // Upload single file with progress
    async function uploadFile(item) {
        item.status = 'uploading';
        renderUploadItem(item);

        const controller = new AbortController();
        uploadControllers.set(item.id, controller);

        const formData = new FormData();
        formData.append('file', item.file);

        try {
            const response = await fetch('/api/documents/upload', {
                method: 'POST',
                body: formData,
                signal: controller.signal
            });

            const result = await response.json();

            if (response.ok) {
                item.status = 'success';
                item.progress = 100;
                showToast(`Uploaded: ${item.file.name}`, 'success');
            } else {
                item.status = 'error';
                item.error = result.detail || result.error || 'Upload failed';
                showToast(`Failed: ${item.file.name}`, 'error');
            }
        } catch (error) {
            if (error.name === 'AbortError') {
                item.status = 'error';
                item.error = 'Cancelled';
            } else {
                item.status = 'error';
                item.error = error.message;
                showToast(`Error: ${item.file.name} - ${error.message}`, 'error');
            }
        } finally {
            uploadControllers.delete(item.id);
            renderUploadItem(item);

            // Continue processing queue
            processUploadQueue();

            // Refresh documents if all uploads complete
            const stillUploading = uploadQueue.some(i => i.status === 'uploading' || i.status === 'pending');
            if (!stillUploading) {
                loadDocuments();
                refreshStats();
            }
        }
    }

    // Cancel single upload
    function cancelUpload(id) {
        const controller = uploadControllers.get(id);
        if (controller) {
            controller.abort();
        }

        const item = uploadQueue.find(i => i.id === id);
        if (item && item.status === 'pending') {
            item.status = 'error';
            item.error = 'Cancelled';
            renderUploadItem(item);
        }
    }

    // Cancel all uploads
    function cancelAllUploads() {
        uploadControllers.forEach(controller => controller.abort());
        uploadQueue.forEach(item => {
            if (item.status === 'pending' || item.status === 'uploading') {
                item.status = 'error';
                item.error = 'Cancelled';
                renderUploadItem(item);
            }
        });
    }

    // Clear completed uploads
    function clearCompletedUploads() {
        uploadQueue = uploadQueue.filter(item => item.status === 'uploading' || item.status === 'pending');
        const queueItems = document.getElementById('uploadQueueItems');
        queueItems.innerHTML = '';
        uploadQueue.forEach(item => renderUploadItem(item));

        if (uploadQueue.length === 0) {
            document.getElementById('uploadQueue').classList.remove('show');
        }
    }

    // Load characters
    async function loadCharacters() {
        try {
            const response = await fetch('/api/characters');
            const data = await response.json();
            if (response.ok) {
                characters = data.characters || [];
            }
        } catch (error) {
            console.error('Error loading characters:', error);
            characters = [];
        }
    }

    // Load documents
    async function loadDocuments() {
        const container = document.getElementById('documentsContainer');

        try {
            const response = await fetch('/api/documents/');
            const data = await response.json();

            if (response.ok) {
                documents = data.documents;
                renderDocuments(documents);
            } else {
                container.innerHTML = `<tr><td colspan="6"><div class="text-danger">Error loading documents</div></td></tr>`;
            }
        } catch (error) {
            container.innerHTML = `<tr><td colspan="6"><div class="text-danger">Error: ${error.message}</div></td></tr>`;
        }
    }

    // Render documents
    function renderDocuments(docs) {
        const container = document.getElementById('documentsContainer');

        if (docs.length === 0) {
            container.innerHTML = `
                <tr>
                    <td colspan="6">
                        <div class="empty-state">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                            </svg>
                            <div class="empty-state-title">No documents yet</div>
                            <div class="empty-state-text">Upload your first document to get started</div>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }

        const rows = docs.map(doc => `
            <tr>
                <td>
                    <div class="doc-name">
                        ${getFileIcon(doc.doc_type)}
                        <span title="${doc.original_filename}">${truncate(doc.original_filename, 30)}</span>
                    </div>
                </td>
                <td>${formatFileSize(doc.file_size)}</td>
                <td>${new Date(doc.upload_date).toLocaleDateString()}</td>
                <td>
                    <span class="status-dot ${doc.processing_status}"></span>
                    ${doc.processing_status}
                </td>
                <td>
                    <div class="persona-chips" id="assignments-${doc.id}">
                        <span class="persona-chip">Loading...</span>
                    </div>
                </td>
                <td>
                    <div class="doc-actions">
                        <button class="btn btn-ghost btn-sm" onclick="viewDocument('${doc.id}')" title="View content">
                            <i data-lucide="eye" style="width: 14px; height: 14px;"></i>
                        </button>
                        <button class="btn btn-ghost btn-sm" onclick="manageAssignments('${doc.id}', '${escapeHtml(doc.original_filename)}')" title="Manage personas">
                            <i data-lucide="users" style="width: 14px; height: 14px;"></i>
                        </button>
                        <button class="btn btn-ghost btn-sm" onclick="reprocessDocument('${doc.id}')" title="Reprocess">
                            <i data-lucide="refresh-cw" style="width: 14px; height: 14px;"></i>
                        </button>
                        <button class="btn btn-ghost btn-sm" onclick="showDeleteModal('${doc.id}', '${escapeHtml(doc.original_filename)}')" title="Delete">
                            <i data-lucide="trash-2" style="width: 14px; height: 14px;"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');

        container.innerHTML = rows;
        lucide.createIcons();
        loadCharacterAssignments();
    }

    // Load character assignments
    async function loadCharacterAssignments() {
        for (const doc of documents) {
            await loadDocumentAssignments(doc.id);
        }
    }

    // Load assignments for a specific document
    async function loadDocumentAssignments(documentId) {
        try {
            const response = await fetch(`/api/documents/character-associations/${documentId}`);
            const data = await response.json();

            if (response.ok) {
                const associations = data.character_associations || data.associations || [];
                const activeAssignments = Array.isArray(associations) ?
                    associations.filter(assoc => assoc.is_active !== false) : [];
                displayAssignments(documentId, activeAssignments);
            } else {
                displayAssignments(documentId, []);
            }
        } catch (error) {
            displayAssignments(documentId, []);
        }
    }

    // Display assignments as chips
    function displayAssignments(documentId, assignments) {
        const container = document.getElementById(`assignments-${documentId}`);
        if (!container) return;

        if (assignments.length === 0) {
            container.innerHTML = '<span class="text-muted text-xs">None</span>';
            return;
        }

        const chips = assignments.map(assoc => {
            const character = characters.find(c => c.id === assoc.character_id);
            const name = character ? character.name : 'Unknown';
            return `<span class="persona-chip">${name}</span>`;
        }).join('');

        container.innerHTML = chips;
    }

    // Search documents
    async function searchDocuments() {
        const query = document.getElementById('searchQuery').value.trim();
        const resultsContainer = document.getElementById('searchResults');

        if (!query) {
            resultsContainer.innerHTML = '';
            return;
        }

        resultsContainer.innerHTML = '<div class="loading-indicator"><div class="spinner"></div><span>Searching...</span></div>';

        try {
            const response = await fetch('/api/documents/search', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    query: query,
                    top_k: 10,
                    similarity_threshold: 0.3
                })
            });

            const results = await response.json();

            if (response.ok && results.length > 0) {
                const resultsHtml = results.map(result => `
                    <div class="search-result-item">
                        <div class="search-result-header">
                            <span class="search-result-title">${result.document_filename}</span>
                            <span class="similarity-badge">${(result.similarity_score * 100).toFixed(1)}%</span>
                        </div>
                        <p class="search-result-text">${result.text_content.substring(0, 200)}...</p>
                        <div class="search-result-meta">Chunk ${result.chunk_index + 1} | Type: ${result.chunk_type}</div>
                    </div>
                `).join('');

                resultsContainer.innerHTML = `
                    <p class="text-sm text-muted mb-3">Found ${results.length} relevant passages:</p>
                    ${resultsHtml}
                `;
            } else {
                resultsContainer.innerHTML = '<p class="text-muted text-sm">No relevant documents found.</p>';
            }
        } catch (error) {
            resultsContainer.innerHTML = `<p class="text-danger text-sm">Search error: ${error.message}</p>`;
        }
    }

    // Refresh statistics
    async function refreshStats() {
        try {
            const response = await fetch('/api/documents/stats/overview');
            const stats = await response.json();

            if (response.ok) {
                document.getElementById('totalDocs').textContent = stats.total_documents;
                document.getElementById('processedDocs').textContent = stats.processed_documents;
                document.getElementById('totalSize').textContent = formatFileSize(stats.total_size_bytes);
            }
        } catch (error) {
            console.error('Error loading stats:', error);
        }
    }

    // View document content
    async function viewDocument(documentId) {
        try {
            const response = await fetch(`/api/documents/${documentId}/content`);
            const data = await response.json();

            if (response.ok) {
                document.getElementById('contentPreview').textContent = data.content;
                openContentModal();
            } else {
                showToast('Error loading document content', 'error');
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        }
    }

    // Reprocess document
    async function reprocessDocument(documentId) {
        try {
            const response = await fetch(`/api/documents/${documentId}/reprocess`, {
                method: 'POST'
            });

            if (response.ok) {
                showToast('Document reprocessing initiated', 'success');
                loadDocuments();
            } else {
                const error = await response.json();
                showToast('Error: ' + (error.detail || error.error), 'error');
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        }
    }

    // Delete document
    function showDeleteModal(documentId, filename) {
        currentDeleteDocId = documentId;
        document.getElementById('deleteDocName').textContent = filename;
        document.getElementById('deleteModalBackdrop').classList.add('show');
        document.getElementById('deleteModal').classList.add('show');
    }

    function closeDeleteModal() {
        document.getElementById('deleteModalBackdrop').classList.remove('show');
        document.getElementById('deleteModal').classList.remove('show');
        currentDeleteDocId = null;
    }

    async function confirmDelete() {
        if (!currentDeleteDocId) return;

        try {
            const response = await fetch(`/api/documents/${currentDeleteDocId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                showToast('Document deleted', 'success');
                loadDocuments();
                refreshStats();
            } else {
                const error = await response.json();
                showToast('Error: ' + (error.detail || error.error), 'error');
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        }

        closeDeleteModal();
    }

    // Manage assignments
    function manageAssignments(documentId, filename) {
        currentAssignmentDocId = documentId;
        document.getElementById('assignmentDocName').textContent = `Document: ${filename}`;
        loadAssignmentModal(documentId);
        document.getElementById('assignmentModalBackdrop').classList.add('show');
        document.getElementById('assignmentModal').classList.add('show');
    }

    function closeAssignmentModal() {
        document.getElementById('assignmentModalBackdrop').classList.remove('show');
        document.getElementById('assignmentModal').classList.remove('show');
        currentAssignmentDocId = null;
    }

    async function loadAssignmentModal(documentId) {
        const container = document.getElementById('characterCheckboxes');

        try {
            const response = await fetch(`/api/documents/character-associations/${documentId}`);
            const data = await response.json();

            const currentAssignments = response.ok ?
                (data.associations || []).filter(assoc => assoc.is_active).map(assoc => assoc.character_id) : [];

            const checkboxesHtml = characters.map(character => `
                <div class="checkbox-item">
                    <input type="checkbox" id="char-${character.id}"
                           data-character-id="${character.id}"
                           ${currentAssignments.includes(character.id) ? 'checked' : ''}>
                    <label class="checkbox-label" for="char-${character.id}">${character.name}</label>
                </div>
            `).join('');

            container.innerHTML = checkboxesHtml || '<p class="text-muted">No personas available</p>';

        } catch (error) {
            container.innerHTML = '<p class="text-danger">Error loading personas</p>';
        }
    }

    async function saveAssignments() {
        if (!currentAssignmentDocId) return;

        const checkboxes = document.querySelectorAll('#characterCheckboxes input[type="checkbox"]');
        const assignments = [];

        checkboxes.forEach(checkbox => {
            assignments.push({
                character_id: checkbox.dataset.characterId,
                document_id: currentAssignmentDocId,
                is_active: checkbox.checked
            });
        });

        let successCount = 0;
        for (const assignment of assignments) {
            try {
                const response = await fetch('/api/documents/character-associations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(assignment)
                });

                if (response.ok) {
                    successCount++;
                }
            } catch (error) {
                console.error('Error saving assignment:', error);
            }
        }

        closeAssignmentModal();

        if (successCount > 0) {
            showToast('Assignments updated', 'success');
            await loadDocumentAssignments(currentAssignmentDocId);
        }
    }

    // Content modal
    function openContentModal() {
        document.getElementById('contentModalBackdrop').classList.add('show');
        document.getElementById('contentModal').classList.add('show');
    }

    function closeContentModal() {
        document.getElementById('contentModalBackdrop').classList.remove('show');
        document.getElementById('contentModal').classList.remove('show');
    }

    // Helper functions
    function getFileIcon(docType) {
        const icons = {
            'pdf': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>',
            'docx': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>',
            'doc': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>',
            'xlsx': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><rect x="8" y="13" width="8" height="6"/></svg>',
            'xls': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>',
            'txt': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>',
            'md': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>',
            'csv': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>'
        };
        return icons[docType] || icons['txt'];
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function truncate(str, length) {
        if (str.length <= length) return str;
        return str.substring(0, length) + '...';
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Search on Enter key
    document.getElementById('searchQuery').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchDocuments();
        }
    });

    // Close modals on backdrop click
    document.getElementById('contentModalBackdrop').addEventListener('click', closeContentModal);
    document.getElementById('assignmentModalBackdrop').addEventListener('click', closeAssignmentModal);
    document.getElementById('deleteModalBackdrop').addEventListener('click', closeDeleteModal);
</script>
{% endblock %}
