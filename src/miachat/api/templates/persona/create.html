{% extends "base.html" %}
{% block title %}Create Persona - MinouChat{% endblock %}
{% set active_page = 'personas' %}

{% block head %}
<style>
    .wizard-container {
        max-width: 640px;
        width: 100%;
        margin: 0 auto;
        padding: var(--space-6);
        box-sizing: border-box;
    }

    .wizard-container * {
        box-sizing: border-box;
    }

    .wizard-header {
        text-align: center;
        margin-bottom: var(--space-8);
    }

    .wizard-title {
        font-size: var(--text-2xl);
        font-weight: var(--font-semibold);
        margin-bottom: var(--space-2);
    }

    .wizard-subtitle {
        color: var(--text-muted);
        font-size: var(--text-sm);
    }

    /* Progress indicator */
    .wizard-progress {
        display: flex;
        justify-content: center;
        gap: var(--space-3);
        margin-bottom: var(--space-8);
    }

    .progress-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: var(--border-color);
        transition: all var(--transition-fast);
    }

    .progress-dot.active {
        background: var(--text-primary);
        transform: scale(1.2);
    }

    .progress-dot.completed {
        background: var(--pop-success);
    }

    /* Step container */
    .step-panel {
        display: none;
        animation: fadeIn 0.3s ease;
        width: 100%;
    }

    .step-panel.active {
        display: block;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
    }

    /* Form elements */
    .form-group {
        margin-bottom: var(--space-6);
    }

    .form-label {
        display: block;
        font-size: var(--text-sm);
        font-weight: var(--font-medium);
        color: var(--text-secondary);
        margin-bottom: var(--space-2);
    }

    .form-input {
        width: 100%;
        padding: var(--space-3) var(--space-4);
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        font-size: var(--text-base);
        color: var(--text-primary);
        transition: border-color var(--transition-fast);
    }

    .form-input:focus {
        outline: none;
        border-color: var(--text-primary);
    }

    .form-textarea {
        min-height: 120px;
        resize: vertical;
    }

    .form-hint {
        font-size: var(--text-xs);
        color: var(--text-muted);
        margin-top: var(--space-2);
    }

    .form-error {
        font-size: var(--text-xs);
        color: var(--pop-danger);
        margin-top: var(--space-2);
        display: none;
    }

    .form-error.visible {
        display: block;
    }

    .form-input.error {
        border-color: var(--pop-danger);
    }

    .error-banner {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid var(--pop-danger);
        border-radius: var(--radius-md);
        padding: var(--space-4);
        margin-bottom: var(--space-4);
        display: none;
    }

    .error-banner.visible {
        display: flex;
        align-items: flex-start;
        gap: var(--space-3);
    }

    .error-banner svg {
        color: var(--pop-danger);
        flex-shrink: 0;
    }

    .error-banner-text {
        font-size: var(--text-sm);
        color: var(--text-secondary);
    }

    .error-banner-text a {
        color: var(--pop-primary);
        text-decoration: underline;
    }

    /* Category selection */
    .category-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: var(--space-3);
    }

    .category-option {
        padding: var(--space-4);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        text-align: center;
        cursor: pointer;
        transition: all var(--transition-fast);
        background: var(--bg-primary);
    }

    .category-option:hover {
        border-color: var(--text-muted);
    }

    .category-option.selected {
        border-color: var(--text-primary);
        background: var(--bg-secondary);
    }

    .category-option input {
        display: none;
    }

    .category-icon {
        margin-bottom: var(--space-2);
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .category-icon svg {
        width: 24px;
        height: 24px;
        stroke: currentColor;
        stroke-width: 1.5;
        fill: none;
    }

    .category-label {
        font-size: var(--text-sm);
        font-weight: var(--font-medium);
    }

    /* Style controls */
    .style-control {
        margin-bottom: var(--space-5);
    }

    .style-label {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: var(--space-2);
    }

    .style-name {
        font-size: var(--text-sm);
        font-weight: var(--font-medium);
        color: var(--text-secondary);
    }

    .style-default-badge {
        font-size: var(--text-xs);
        color: var(--text-muted);
        padding: var(--space-1) var(--space-2);
        background: var(--bg-tertiary);
        border-radius: var(--radius-sm);
    }

    .style-options {
        display: flex;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        overflow: hidden;
    }

    .style-option {
        flex: 1;
        padding: var(--space-3);
        text-align: center;
        font-size: var(--text-sm);
        cursor: pointer;
        border-right: 1px solid var(--border-color);
        background: var(--bg-primary);
        transition: all var(--transition-fast);
    }

    .style-option:last-child {
        border-right: none;
    }

    .style-option:hover {
        background: var(--bg-secondary);
    }

    .style-option.selected {
        background: var(--text-primary);
        color: var(--bg-primary);
    }

    .style-option.is-default {
        font-weight: var(--font-medium);
    }

    .style-option input {
        display: none;
    }

    /* Preview box */
    .preview-box {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        padding: var(--space-4);
        margin-top: var(--space-4);
    }

    .preview-label {
        font-size: var(--text-xs);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted);
        margin-bottom: var(--space-2);
    }

    .preview-content {
        font-size: var(--text-sm);
        color: var(--text-secondary);
        line-height: 1.6;
        white-space: pre-wrap;
    }

    /* Actions */
    .wizard-actions {
        display: flex;
        gap: var(--space-3);
        margin-top: var(--space-8);
    }

    .btn {
        padding: var(--space-3) var(--space-6);
        border-radius: var(--radius-md);
        font-size: var(--text-sm);
        font-weight: var(--font-medium);
        cursor: pointer;
        transition: all var(--transition-fast);
        border: 1px solid transparent;
    }

    .btn-primary {
        background: var(--text-primary);
        color: var(--bg-primary);
        flex: 1;
    }

    .btn-primary:hover {
        opacity: 0.9;
    }

    .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn-secondary {
        background: transparent;
        border-color: var(--border-color);
        color: var(--text-secondary);
    }

    .btn-secondary:hover {
        border-color: var(--text-muted);
    }

    .btn-generate {
        background: var(--bg-secondary);
        border-color: var(--border-color);
        color: var(--text-secondary);
        margin-top: var(--space-3);
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-2);
    }

    .btn-generate:hover {
        border-color: var(--pop-primary);
        color: var(--pop-primary);
    }

    .btn-generate.loading {
        pointer-events: none;
        opacity: 0.7;
    }

    /* Skip link */
    .skip-link {
        text-align: center;
        margin-top: var(--space-4);
    }

    .skip-link a {
        font-size: var(--text-sm);
        color: var(--text-muted);
        text-decoration: none;
    }

    .skip-link a:hover {
        color: var(--text-secondary);
        text-decoration: underline;
    }

    /* Info box */
    .info-box {
        display: flex;
        align-items: flex-start;
        gap: var(--space-3);
        padding: var(--space-4);
        background: var(--bg-secondary);
        border-radius: var(--radius-md);
        margin-bottom: var(--space-6);
    }

    .info-box svg {
        flex-shrink: 0;
        color: var(--text-muted);
    }

    .info-box-text {
        font-size: var(--text-sm);
        color: var(--text-secondary);
        line-height: 1.5;
    }

    /* Changes badge */
    .changes-badge {
        display: inline-flex;
        align-items: center;
        gap: var(--space-1);
        font-size: var(--text-xs);
        color: var(--pop-primary);
        margin-top: var(--space-2);
    }
</style>
{% endblock %}

{% block content %}
<div class="wizard-container">
    <div class="wizard-header">
        <h1 class="wizard-title">Create a Persona</h1>
        <p class="wizard-subtitle">Build your AI companion step by step</p>
    </div>

    <!-- Progress dots -->
    <div class="wizard-progress">
        <div class="progress-dot active" data-step="1"></div>
        <div class="progress-dot" data-step="2"></div>
        <div class="progress-dot" data-step="3"></div>
    </div>

    <!-- Step 1: Basics -->
    <div class="step-panel active" data-step="1">
        <div class="form-group">
            <label class="form-label">Persona Name <span style="color: var(--pop-danger);">*</span></label>
            <input type="text" id="persona-name" class="form-input" placeholder="e.g., Sage, Alex, or Coach" maxlength="50" required>
            <p class="form-hint">Choose a memorable name for your persona</p>
            <p class="form-error" id="name-error">Please enter a name for your persona</p>
        </div>

        <div class="form-group">
            <label class="form-label">What type of persona is this?</label>
            <div class="category-grid">
                <label class="category-option" data-category="Coach">
                    <input type="radio" name="category" value="Coach">
                    <div class="category-icon">
                        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 8v8M8 12h8"/></svg>
                    </div>
                    <div class="category-label">Coach</div>
                </label>
                <label class="category-option" data-category="Assistant">
                    <input type="radio" name="category" value="Assistant">
                    <div class="category-icon">
                        <svg viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>
                    </div>
                    <div class="category-label">Assistant</div>
                </label>
                <label class="category-option" data-category="Friend">
                    <input type="radio" name="category" value="Friend">
                    <div class="category-icon">
                        <svg viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    </div>
                    <div class="category-label">Friend</div>
                </label>
                <label class="category-option" data-category="Teacher">
                    <input type="radio" name="category" value="Teacher">
                    <div class="category-icon">
                        <svg viewBox="0 0 24 24"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                    </div>
                    <div class="category-label">Teacher</div>
                </label>
                <label class="category-option" data-category="Advisor">
                    <input type="radio" name="category" value="Advisor">
                    <div class="category-icon">
                        <svg viewBox="0 0 24 24"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>
                    </div>
                    <div class="category-label">Advisor</div>
                </label>
                <label class="category-option" data-category="Creative">
                    <input type="radio" name="category" value="Creative">
                    <div class="category-icon">
                        <svg viewBox="0 0 24 24"><circle cx="13.5" cy="6.5" r="0.5" fill="currentColor"/><circle cx="17.5" cy="10.5" r="0.5" fill="currentColor"/><circle cx="8.5" cy="7.5" r="0.5" fill="currentColor"/><circle cx="6.5" cy="12.5" r="0.5" fill="currentColor"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.555C21.965 6.012 17.461 2 12 2z"/></svg>
                    </div>
                    <div class="category-label">Creative</div>
                </label>
            </div>
        </div>

        <div class="wizard-actions">
            <a href="/personas" class="btn btn-secondary">Cancel</a>
            <button type="button" class="btn btn-primary" id="step1-next" disabled>Next</button>
        </div>
    </div>

    <!-- Step 2: Personality -->
    <div class="step-panel" data-step="2">
        <!-- Error banner for LLM issues -->
        <div class="error-banner" id="llm-error-banner">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 8v4M12 16h.01"/>
            </svg>
            <div class="error-banner-text" id="llm-error-text">
                No AI provider is available. <a href="/settings">Configure an API key</a> or start Ollama to generate instructions.
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Describe this persona</label>
            <textarea id="persona-description" class="form-input form-textarea" placeholder="Describe the persona's role, expertise, and how they should interact with you..."></textarea>
            <p class="form-hint">This helps generate better instructions for your persona</p>
        </div>

        <button type="button" class="btn btn-generate" id="generate-btn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
            </svg>
            Generate Instructions
        </button>

        <div class="preview-box" id="preview-box" style="display: none;">
            <div class="preview-label">Preview</div>
            <div class="preview-content" id="preview-content"></div>
        </div>

        <div class="wizard-actions">
            <button type="button" class="btn btn-secondary" id="step2-back">Back</button>
            <button type="button" class="btn btn-primary" id="step2-next">Next</button>
        </div>

        <div class="skip-link">
            <a href="#" id="skip-styles">Skip style adjustments and create</a>
        </div>
    </div>

    <!-- Step 3: Fine-tune -->
    <div class="step-panel" data-step="3">
        <div class="info-box">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 16v-4M12 8h.01"/>
            </svg>
            <div class="info-box-text">
                These settings are optional. The defaults are based on your chosen category (<strong id="category-display">Coach</strong>). Only changes from defaults will affect the persona's behavior.
            </div>
        </div>

        <!-- Warmth -->
        <div class="style-control">
            <div class="style-label">
                <span class="style-name">Warmth</span>
                <span class="style-default-badge" id="warmth-default">Default: Neutral</span>
            </div>
            <div class="style-options" data-style="warmth">
                <label class="style-option" data-value="cold">
                    <input type="radio" name="warmth" value="cold">
                    Cold
                </label>
                <label class="style-option" data-value="neutral">
                    <input type="radio" name="warmth" value="neutral">
                    Neutral
                </label>
                <label class="style-option" data-value="warm">
                    <input type="radio" name="warmth" value="warm">
                    Warm
                </label>
            </div>
        </div>

        <!-- Formality -->
        <div class="style-control">
            <div class="style-label">
                <span class="style-name">Formality</span>
                <span class="style-default-badge" id="formality-default">Default: Formal</span>
            </div>
            <div class="style-options" data-style="formality">
                <label class="style-option" data-value="casual">
                    <input type="radio" name="formality" value="casual">
                    Casual
                </label>
                <label class="style-option" data-value="neutral">
                    <input type="radio" name="formality" value="neutral">
                    Neutral
                </label>
                <label class="style-option" data-value="formal">
                    <input type="radio" name="formality" value="formal">
                    Formal
                </label>
            </div>
        </div>

        <!-- Directness -->
        <div class="style-control">
            <div class="style-label">
                <span class="style-name">Directness</span>
                <span class="style-default-badge" id="directness-default">Default: Direct</span>
            </div>
            <div class="style-options" data-style="directness">
                <label class="style-option" data-value="gentle">
                    <input type="radio" name="directness" value="gentle">
                    Gentle
                </label>
                <label class="style-option" data-value="balanced">
                    <input type="radio" name="directness" value="balanced">
                    Balanced
                </label>
                <label class="style-option" data-value="direct">
                    <input type="radio" name="directness" value="direct">
                    Direct
                </label>
            </div>
        </div>

        <!-- Humor -->
        <div class="style-control">
            <div class="style-label">
                <span class="style-name">Humor</span>
                <span class="style-default-badge" id="humor-default">Default: Minimal</span>
            </div>
            <div class="style-options" data-style="humor">
                <label class="style-option" data-value="minimal">
                    <input type="radio" name="humor" value="minimal">
                    Minimal
                </label>
                <label class="style-option" data-value="moderate">
                    <input type="radio" name="humor" value="moderate">
                    Moderate
                </label>
                <label class="style-option" data-value="playful">
                    <input type="radio" name="humor" value="playful">
                    Playful
                </label>
            </div>
        </div>

        <div id="changes-count" class="changes-badge" style="display: none;">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 8v4M12 16h.01"/>
            </svg>
            <span id="changes-text">0 changed from defaults</span>
        </div>

        <div class="wizard-actions">
            <button type="button" class="btn btn-secondary" id="step3-back">Back</button>
            <button type="button" class="btn btn-primary" id="create-persona">Create Persona</button>
        </div>
    </div>
</div>

<script>
// Category defaults from backend
const CATEGORY_DEFAULTS = {
    "Coach": { warmth: "neutral", formality: "formal", directness: "direct", humor: "minimal" },
    "Assistant": { warmth: "neutral", formality: "formal", directness: "balanced", humor: "minimal" },
    "Friend": { warmth: "warm", formality: "casual", directness: "balanced", humor: "moderate" },
    "Teacher": { warmth: "warm", formality: "neutral", directness: "balanced", humor: "moderate" },
    "Advisor": { warmth: "neutral", formality: "formal", directness: "direct", humor: "minimal" },
    "Companion": { warmth: "warm", formality: "casual", directness: "gentle", humor: "playful" },
    "Roleplay": { warmth: "neutral", formality: "neutral", directness: "balanced", humor: "moderate" },
    "Creative": { warmth: "warm", formality: "casual", directness: "gentle", humor: "playful" },
    "Other": { warmth: "neutral", formality: "neutral", directness: "balanced", humor: "moderate" }
};

// State
let currentStep = 1;
let personaData = {
    name: '',
    category: '',
    description: '',
    system_prompt: '',
    communication_style: {}
};

// Elements
const steps = document.querySelectorAll('.step-panel');
const progressDots = document.querySelectorAll('.progress-dot');
const nameInput = document.getElementById('persona-name');
const categoryOptions = document.querySelectorAll('.category-option');
const descriptionInput = document.getElementById('persona-description');
const previewBox = document.getElementById('preview-box');
const previewContent = document.getElementById('preview-content');

// Step 1: Category selection
categoryOptions.forEach(option => {
    option.addEventListener('click', () => {
        categoryOptions.forEach(o => o.classList.remove('selected'));
        option.classList.add('selected');
        option.querySelector('input').checked = true;
        personaData.category = option.dataset.category;
        validateStep1();
    });
});

// Step 1: Name input
nameInput.addEventListener('input', () => {
    personaData.name = nameInput.value.trim();
    // Clear error state when typing
    nameInput.classList.remove('error');
    document.getElementById('name-error').classList.remove('visible');
    validateStep1();
});

// Also validate on blur (when user leaves the field)
nameInput.addEventListener('blur', () => {
    if (!personaData.name && nameInput.value === '') {
        nameInput.classList.add('error');
        document.getElementById('name-error').classList.add('visible');
    }
});

function validateStep1() {
    const valid = personaData.name.length > 0 && personaData.category;
    document.getElementById('step1-next').disabled = !valid;
}

// Show validation feedback when clicking Next without valid input
document.getElementById('step1-next').addEventListener('click', (e) => {
    if (!personaData.name) {
        e.preventDefault();
        e.stopPropagation();
        nameInput.classList.add('error');
        document.getElementById('name-error').classList.add('visible');
        nameInput.focus();
        return false;
    }
    if (!personaData.category) {
        e.preventDefault();
        e.stopPropagation();
        // Visual shake on categories
        document.querySelector('.category-grid').style.animation = 'shake 0.3s';
        setTimeout(() => {
            document.querySelector('.category-grid').style.animation = '';
        }, 300);
        return false;
    }
    goToStep(2);
    initializeStyleDefaults();
});

// Navigation (step1-next handler is above with validation)
document.getElementById('step2-back').addEventListener('click', () => goToStep(1));
document.getElementById('step2-next').addEventListener('click', () => goToStep(3));
document.getElementById('step3-back').addEventListener('click', () => goToStep(2));

document.getElementById('skip-styles').addEventListener('click', (e) => {
    e.preventDefault();
    createPersona();
});

function goToStep(step) {
    currentStep = step;
    steps.forEach(s => s.classList.remove('active'));
    document.querySelector(`.step-panel[data-step="${step}"]`).classList.add('active');

    progressDots.forEach((dot, i) => {
        dot.classList.remove('active', 'completed');
        if (i + 1 < step) dot.classList.add('completed');
        if (i + 1 === step) dot.classList.add('active');
    });
}

// Initialize style defaults based on category
function initializeStyleDefaults() {
    const defaults = CATEGORY_DEFAULTS[personaData.category] || CATEGORY_DEFAULTS.Other;
    personaData.communication_style = { ...defaults };

    // Update category display
    document.getElementById('category-display').textContent = personaData.category;

    // Update default badges and select options
    Object.entries(defaults).forEach(([style, value]) => {
        // Update badge
        const badge = document.getElementById(`${style}-default`);
        if (badge) {
            badge.textContent = `Default: ${value.charAt(0).toUpperCase() + value.slice(1)}`;
        }

        // Select the default option
        const options = document.querySelectorAll(`[data-style="${style}"] .style-option`);
        options.forEach(opt => {
            opt.classList.remove('selected', 'is-default');
            if (opt.dataset.value === value) {
                opt.classList.add('selected', 'is-default');
                opt.querySelector('input').checked = true;
            }
        });
    });

    updateChangesCount();
}

// Style option selection
document.querySelectorAll('.style-options').forEach(container => {
    container.querySelectorAll('.style-option').forEach(option => {
        option.addEventListener('click', () => {
            const style = container.dataset.style;
            container.querySelectorAll('.style-option').forEach(o => o.classList.remove('selected'));
            option.classList.add('selected');
            option.querySelector('input').checked = true;
            personaData.communication_style[style] = option.dataset.value;
            updateChangesCount();
        });
    });
});

function updateChangesCount() {
    const defaults = CATEGORY_DEFAULTS[personaData.category] || CATEGORY_DEFAULTS.Other;
    let changes = 0;

    Object.entries(personaData.communication_style).forEach(([style, value]) => {
        if (defaults[style] !== value) changes++;
    });

    const badge = document.getElementById('changes-count');
    const text = document.getElementById('changes-text');

    if (changes > 0) {
        badge.style.display = 'flex';
        text.textContent = `${changes} changed from defaults`;
    } else {
        badge.style.display = 'none';
    }
}

// Generate instructions
document.getElementById('generate-btn').addEventListener('click', async () => {
    const btn = document.getElementById('generate-btn');
    const errorBanner = document.getElementById('llm-error-banner');
    const errorText = document.getElementById('llm-error-text');

    // Hide any previous error
    errorBanner.classList.remove('visible');

    btn.classList.add('loading');
    btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="spin"><circle cx="12" cy="12" r="10" stroke-dasharray="32" stroke-dashoffset="32"/></svg> Generating...';

    personaData.description = descriptionInput.value.trim();

    try {
        const response = await fetch('/api/suggest_system_prompt', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: personaData.name,
                category: personaData.category,
                backstory: personaData.description
            })
        });

        const data = await response.json();

        if (!response.ok) {
            // Handle error responses
            if (response.status === 503 && data.code === 'NO_LLM_AVAILABLE') {
                errorText.innerHTML = data.error + ' <a href="/settings">Configure in Settings</a>';
                errorBanner.classList.add('visible');
                // Still create a fallback prompt
                personaData.system_prompt = `You are ${personaData.name}, a ${personaData.category.toLowerCase()}. ${personaData.description || 'Be helpful and engaging.'}`;
                previewContent.textContent = personaData.system_prompt;
                previewBox.style.display = 'block';
            } else {
                throw new Error(data.error || 'Failed to generate');
            }
        } else if (data.system_prompt) {
            personaData.system_prompt = data.system_prompt;
            previewContent.textContent = data.system_prompt;
            previewBox.style.display = 'block';
        }
    } catch (error) {
        console.error('Failed to generate:', error);
        // Use a fallback prompt
        personaData.system_prompt = `You are ${personaData.name}, a ${personaData.category.toLowerCase()}. ${personaData.description || 'Be helpful and engaging.'}`;
        previewContent.textContent = personaData.system_prompt;
        previewBox.style.display = 'block';
    }

    btn.classList.remove('loading');
    btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/></svg> Regenerate';
});

// Create persona
document.getElementById('create-persona').addEventListener('click', createPersona);

async function createPersona() {
    const btn = document.getElementById('create-persona');
    btn.disabled = true;
    btn.textContent = 'Creating...';

    // Build the final persona object
    // Note: model_config is intentionally omitted - backend will use user's default LLM
    const finalPersona = {
        name: personaData.name,
        category: personaData.category,
        system_prompt: personaData.system_prompt || `You are ${personaData.name}, a ${personaData.category.toLowerCase()}. ${personaData.description || 'Be helpful and engaging.'}`,
        communication_style: personaData.communication_style,
        traits: {}
    };

    try {
        const response = await fetch('/api/characters', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(finalPersona)
        });

        const data = await response.json();
        // API returns {character: {..., id: "..."}, version: 1}
        const characterId = data.character?.id || data.id;
        if (characterId) {
            // Success - redirect to the new persona's edit page
            window.location.href = `/persona/edit/${characterId}`;
        } else {
            throw new Error(data.detail || data.error || 'Failed to create persona');
        }
    } catch (error) {
        console.error('Failed to create persona:', error);
        alert('Failed to create persona. Please try again.');
        btn.disabled = false;
        btn.textContent = 'Create Persona';
    }
}

// Add spin animation
const style = document.createElement('style');
style.textContent = `
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    .spin { animation: spin 1s linear infinite; }
`;
document.head.appendChild(style);
</script>
{% endblock %}
