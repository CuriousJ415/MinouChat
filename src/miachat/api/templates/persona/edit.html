{% extends "base.html" %}
{% block title %}Edit {{ persona.name }} - MinouChat{% endblock %}
{% set active_page = 'personas' %}

{% block head %}
<style>
    .edit-container {
        max-width: 800px;
        margin: 0 auto;
        padding: var(--space-8) var(--space-4);
    }

    .page-header {
        margin-bottom: var(--space-8);
    }

    .page-header h1 {
        margin-bottom: var(--space-1);
    }

    .page-header p {
        color: var(--text-muted);
    }

    .form-card {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        padding: var(--space-6);
        margin-bottom: var(--space-6);
    }

    .form-section-title {
        font-size: var(--text-base);
        font-weight: var(--font-semibold);
        color: var(--text-primary);
        margin-bottom: var(--space-4);
        padding-bottom: var(--space-2);
        border-bottom: 1px solid var(--border-subtle);
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--space-4);
    }

    @media (max-width: 600px) {
        .form-row {
            grid-template-columns: 1fr;
        }
    }

    /* Style controls (3-level segmented buttons) */
    .style-controls {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: var(--space-4);
    }

    .style-group {
        margin-bottom: var(--space-3);
    }

    .style-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-2);
    }

    .style-label {
        font-size: var(--text-sm);
        color: var(--text-secondary);
        font-weight: var(--font-medium);
    }

    .style-changed {
        font-size: var(--text-xs);
        color: var(--pop-primary);
        display: none;
    }

    .style-changed.show {
        display: inline;
    }

    .segmented-control {
        display: flex;
        background: var(--bg-tertiary);
        border-radius: var(--radius-md);
        padding: 2px;
    }

    .segment-btn {
        flex: 1;
        padding: var(--space-2) var(--space-3);
        border: none;
        background: transparent;
        color: var(--text-muted);
        font-size: var(--text-xs);
        font-weight: var(--font-medium);
        cursor: pointer;
        transition: all var(--transition-fast);
        border-radius: var(--radius-sm);
        text-align: center;
    }

    .segment-btn:hover {
        color: var(--text-secondary);
    }

    .segment-btn.active {
        background: var(--bg-primary);
        color: var(--text-primary);
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .changes-badge {
        display: inline-flex;
        align-items: center;
        gap: var(--space-1);
        padding: 2px 8px;
        background: var(--pop-primary);
        color: white;
        border-radius: var(--radius-full);
        font-size: var(--text-xs);
        font-weight: var(--font-medium);
    }

    .changes-badge:empty {
        display: none;
    }

    /* Slider styles for model config */
    .slider-group {
        margin-bottom: var(--space-4);
    }

    .slider-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-2);
    }

    .slider-label {
        font-size: var(--text-sm);
        color: var(--text-secondary);
    }

    .slider-value {
        font-size: var(--text-sm);
        font-weight: var(--font-medium);
        color: var(--text-primary);
        min-width: 24px;
        text-align: right;
    }

    input[type="range"] {
        -webkit-appearance: none;
        width: 100%;
        height: 4px;
        border-radius: 2px;
        background: var(--bg-tertiary);
        outline: none;
    }

    input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: var(--text-primary);
        cursor: pointer;
        transition: transform var(--transition-fast);
    }

    input[type="range"]::-webkit-slider-thumb:hover {
        transform: scale(1.1);
    }

    input[type="range"]::-moz-range-thumb {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: var(--text-primary);
        cursor: pointer;
        border: none;
    }

    .ai-suggest-btn {
        display: inline-flex;
        align-items: center;
        gap: var(--space-2);
        padding: var(--space-1) var(--space-3);
        background: transparent;
        border: 1px solid var(--pop-primary);
        color: var(--pop-primary);
        border-radius: var(--radius-md);
        font-size: var(--text-xs);
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .ai-suggest-btn:hover {
        background: var(--pop-primary);
        color: white;
    }

    .ai-suggest-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .form-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: var(--space-6);
        border-top: 1px solid var(--border-subtle);
    }

    .success-toast {
        position: fixed;
        bottom: var(--space-4);
        right: var(--space-4);
        background: var(--pop-success);
        color: white;
        padding: var(--space-3) var(--space-4);
        border-radius: var(--radius-md);
        font-size: var(--text-sm);
        opacity: 0;
        transform: translateY(20px);
        transition: all var(--transition-normal);
        z-index: 1000;
    }

    .success-toast.show {
        opacity: 1;
        transform: translateY(0);
    }

    /* Collapsible Section */
    .collapsible-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        padding: var(--space-2) 0;
        user-select: none;
    }

    .collapsible-header:hover .form-section-title {
        color: var(--text-primary);
    }

    .collapsible-icon {
        width: 20px;
        height: 20px;
        transition: transform var(--transition-fast);
        color: var(--text-muted);
    }

    .collapsible-header.open .collapsible-icon {
        transform: rotate(180deg);
    }

    .collapsible-content {
        display: none;
        padding-top: var(--space-4);
    }

    .collapsible-content.open {
        display: block;
    }

    /* Tabs */
    .tabs-container {
        margin-top: var(--space-2);
    }

    .tab-nav {
        display: flex;
        gap: var(--space-1);
        border-bottom: 1px solid var(--border-subtle);
        margin-bottom: var(--space-4);
    }

    .tab-btn {
        padding: var(--space-2) var(--space-4);
        background: transparent;
        border: none;
        border-bottom: 2px solid transparent;
        color: var(--text-muted);
        font-size: var(--text-sm);
        font-weight: var(--font-medium);
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .tab-btn:hover {
        color: var(--text-secondary);
    }

    .tab-btn.active {
        color: var(--text-primary);
        border-bottom-color: var(--text-primary);
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    /* Provider Badges */
    .provider-badge {
        display: inline-flex;
        align-items: center;
        gap: var(--space-1);
        padding: 2px 6px;
        background: var(--bg-tertiary);
        border-radius: var(--radius-sm);
        font-size: 10px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .provider-badge.ollama {
        background: rgba(16, 185, 129, 0.15);
        color: var(--pop-success);
    }

    .provider-badge.all {
        background: rgba(59, 130, 246, 0.15);
        color: var(--pop-primary);
    }

    /* Entry List (for World Info and Memory) */
    .entry-list {
        display: flex;
        flex-direction: column;
        gap: var(--space-3);
    }

    .entry-item {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        padding: var(--space-3);
        background: var(--bg-secondary);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-md);
        transition: all var(--transition-fast);
    }

    .entry-item:hover {
        border-color: var(--border-color);
    }

    .entry-info {
        flex: 1;
        min-width: 0;
    }

    .entry-name {
        font-weight: var(--font-medium);
        color: var(--text-primary);
        margin-bottom: var(--space-1);
    }

    .entry-meta {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-2);
        font-size: var(--text-xs);
        color: var(--text-muted);
    }

    .entry-keywords {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-1);
        margin-top: var(--space-2);
    }

    .keyword-tag {
        padding: 2px 8px;
        background: var(--bg-tertiary);
        border-radius: var(--radius-sm);
        font-size: var(--text-xs);
        color: var(--text-secondary);
    }

    .entry-actions {
        display: flex;
        gap: var(--space-2);
        flex-shrink: 0;
    }

    .entry-toggle {
        width: 36px;
        height: 20px;
        background: var(--bg-tertiary);
        border: none;
        border-radius: 10px;
        cursor: pointer;
        position: relative;
        transition: background var(--transition-fast);
    }

    .entry-toggle::after {
        content: '';
        position: absolute;
        width: 16px;
        height: 16px;
        background: white;
        border-radius: 50%;
        top: 2px;
        left: 2px;
        transition: transform var(--transition-fast);
    }

    .entry-toggle.enabled {
        background: var(--pop-success);
    }

    .entry-toggle.enabled::after {
        transform: translateX(16px);
    }

    .btn-icon-sm {
        padding: var(--space-1);
        background: transparent;
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-sm);
        color: var(--text-muted);
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .btn-icon-sm:hover {
        border-color: var(--border-color);
        color: var(--text-primary);
    }

    .btn-icon-sm.danger:hover {
        border-color: var(--pop-danger);
        color: var(--pop-danger);
    }

    .empty-state {
        text-align: center;
        padding: var(--space-8);
        color: var(--text-muted);
    }

    .empty-state i {
        margin-bottom: var(--space-2);
        opacity: 0.5;
    }

    /* Entry Form Modal */
    .entry-form {
        display: none;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        padding: var(--space-4);
        margin-bottom: var(--space-4);
    }

    .entry-form.show {
        display: block;
    }

    .entry-form-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-4);
    }

    .entry-form-title {
        font-weight: var(--font-medium);
        color: var(--text-primary);
    }

    .position-select {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-2);
    }

    .position-option {
        flex: 1;
        min-width: 120px;
        padding: var(--space-2) var(--space-3);
        background: var(--bg-primary);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-md);
        text-align: center;
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .position-option:hover {
        border-color: var(--border-color);
    }

    .position-option.selected {
        border-color: var(--text-primary);
        background: var(--bg-tertiary);
    }

    .position-option-label {
        font-size: var(--text-sm);
        font-weight: var(--font-medium);
        color: var(--text-primary);
    }

    .position-option-desc {
        font-size: var(--text-xs);
        color: var(--text-muted);
        margin-top: var(--space-1);
    }
</style>
{% endblock %}

{% block content %}
<div class="edit-container">
    <div class="page-header">
        <h1>Edit {{ persona.name }}</h1>
        <p>Modify your AI persona's personality and settings</p>
    </div>

    <form id="persona-form" novalidate>
        <!-- Basic Information -->
        <div class="form-card">
            <h3 class="form-section-title">Basic Information</h3>

            <!-- Avatar Upload Section -->
            <div class="avatar-section" style="margin-bottom: var(--space-6);">
                <div class="avatar-upload-container" style="display: flex; align-items: flex-start; gap: var(--space-4);">
                    <div class="avatar-preview-wrapper" style="position: relative;">
                        <div class="avatar-preview" id="avatar-preview"
                             style="width: 100px; height: 100px; border-radius: 50%; background: var(--bg-tertiary);
                                    border: 2px dashed var(--border-color); display: flex; align-items: center;
                                    justify-content: center; overflow: hidden; cursor: pointer; transition: all var(--transition-fast);">
                            {% if persona.avatar_url %}
                            <img src="{{ persona.avatar_url }}" alt="{{ persona.name }}"
                                 style="width: 100%; height: 100%; object-fit: cover;">
                            {% else %}
                            <i data-lucide="user" style="width: 40px; height: 40px; color: var(--text-muted);"></i>
                            {% endif %}
                        </div>
                        {% if persona.avatar_url %}
                        <button type="button" class="avatar-remove-btn" id="remove-avatar-btn"
                                style="position: absolute; top: -8px; right: -8px; width: 24px; height: 24px;
                                       border-radius: 50%; background: var(--pop-danger); border: none;
                                       color: white; cursor: pointer; display: flex; align-items: center;
                                       justify-content: center; font-size: 14px; line-height: 1;">Ã—</button>
                        {% endif %}
                    </div>
                    <div class="avatar-upload-info">
                        <label class="form-label">Avatar</label>
                        <p style="color: var(--text-muted); font-size: var(--text-xs); margin-bottom: var(--space-2);">
                            Upload a profile image. It will be cropped to a circle.
                        </p>
                        <input type="file" id="avatar-input" name="avatar" accept="image/*"
                               style="display: none;">
                        <button type="button" class="btn btn-secondary btn-sm" id="upload-avatar-btn"
                                style="padding: var(--space-2) var(--space-3); font-size: var(--text-xs);">
                            <i data-lucide="upload" style="width: 14px; height: 14px; margin-right: var(--space-1);"></i>
                            Upload Image
                        </button>
                        <span id="avatar-status" style="display: none; margin-left: var(--space-2);
                              font-size: var(--text-xs); color: var(--text-muted);"></span>
                    </div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="name" class="form-label">Name</label>
                    <input type="text" class="form-input" id="name" name="name"
                           value="{{ persona.name or '' }}" placeholder="e.g., Sage, Luna, Max" required>
                </div>

                <div class="form-group">
                    <label for="category-select" class="form-label">Category</label>
                    <select class="form-input" id="category-select" name="category">
                        <option value="Coach">Coach</option>
                        <option value="Assistant">Assistant</option>
                        <option value="Friend">Friend</option>
                        <option value="Teacher">Teacher</option>
                        <option value="Advisor">Advisor</option>
                        <option value="Companion">Companion</option>
                        <option value="Roleplay">Roleplay</option>
                        <option value="Creative">Creative</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
            </div>

            <!-- Privacy Options -->
            <div class="form-group" style="margin-top: var(--space-4);">
                <label class="form-label" style="display: flex; align-items: center; gap: var(--space-2); cursor: pointer;">
                    <input type="checkbox" id="hide-category" name="hide_category"
                           {% if persona.hide_category %}checked{% endif %}
                           style="width: 18px; height: 18px; cursor: pointer;">
                    <span>Hide category in persona list</span>
                </label>
                <span class="form-hint">When enabled, shows just the name (e.g., "Luna" instead of "Luna (Friend)")</span>
            </div>
        </div>

        <!-- Companion Mode (for Friend/Companion/Roleplay categories) -->
        <div class="form-card" id="companion-mode-section" style="display: none;">
            <div class="collapsible-header" onclick="toggleCompanionSettings()">
                <div style="display: flex; align-items: center; gap: var(--space-2);">
                    <h3 class="form-section-title" style="margin: 0; border: none; padding: 0;">
                        Companion Mode
                    </h3>
                    <span class="form-hint" style="margin: 0;">(Relationship dynamics)</span>
                </div>
                <i data-lucide="chevron-down" class="collapsible-icon" id="companion-icon"></i>
            </div>

            <div class="collapsible-content" id="companion-content" style="display: none;">
                <p style="color: var(--text-muted); font-size: var(--text-sm); margin-bottom: var(--space-4);">
                    Enable enhanced relationship dynamics for romantic companions.
                </p>

                <!-- Enable Toggle -->
                <div class="form-group">
                    <label class="form-label" style="display: flex; align-items: center; gap: var(--space-2); cursor: pointer;">
                        <input type="checkbox" id="companion-mode" name="companion_mode"
                               {% if persona.companion_mode %}checked{% endif %}
                               onchange="toggleCompanionOptions()"
                               style="width: 18px; height: 18px; cursor: pointer;">
                        <span>Enable Companion Mode</span>
                    </label>
                </div>

                <!-- Companion Options (shown when enabled) -->
                <div id="companion-options" style="display: none; margin-top: var(--space-4); padding-top: var(--space-4); border-top: 1px solid var(--border-subtle);">

                    <!-- Intimacy Style -->
                    <div class="form-group">
                        <label for="intimacy-style" class="form-label">Intimacy Style</label>
                        <select class="form-input" id="intimacy-style" name="intimacy_style">
                            <option value="reserved" {% if persona.intimacy_style == 'reserved' %}selected{% endif %}>Reserved - Warm friendship, subtle affection</option>
                            <option value="affectionate" {% if persona.intimacy_style == 'affectionate' %}selected{% endif %}>Affectionate - Open affection, light flirting</option>
                            <option value="romantic" {% if persona.intimacy_style == 'romantic' or not persona.intimacy_style %}selected{% endif %}>Romantic - Full relationship dynamic</option>
                            <option value="passionate" {% if persona.intimacy_style == 'passionate' %}selected{% endif %}>Passionate - Unrestricted expression</option>
                        </select>
                    </div>

                    <!-- Connection Depth -->
                    <div class="form-group">
                        <label for="connection-depth" class="form-label">Connection Depth</label>
                        <select class="form-input" id="connection-depth" name="connection_depth">
                            <option value="casual" {% if persona.connection_depth == 'casual' %}selected{% endif %}>Casual - Light, fun conversations</option>
                            <option value="meaningful" {% if persona.connection_depth == 'meaningful' or not persona.connection_depth %}selected{% endif %}>Meaningful - Emotional support, personal sharing</option>
                            <option value="intimate" {% if persona.connection_depth == 'intimate' %}selected{% endif %}>Intimate - Deep trust, vulnerability</option>
                        </select>
                    </div>

                    <!-- Affection Expressions -->
                    <div class="form-group">
                        <label class="form-label">Affection Expressions</label>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-2);">
                            <label style="display: flex; align-items: center; gap: var(--space-2); cursor: pointer; font-size: var(--text-sm);">
                                <input type="checkbox" name="affection_pet_names" {% if 'pet_names' in (persona.affection_expressions or []) %}checked{% endif %}>
                                <span>Pet names</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: var(--space-2); cursor: pointer; font-size: var(--text-sm);">
                                <input type="checkbox" name="affection_flirting" {% if 'flirting' in (persona.affection_expressions or []) %}checked{% endif %}>
                                <span>Flirting</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: var(--space-2); cursor: pointer; font-size: var(--text-sm);">
                                <input type="checkbox" name="affection_physical" {% if 'physical_affection' in (persona.affection_expressions or []) %}checked{% endif %}>
                                <span>Physical affection</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: var(--space-2); cursor: pointer; font-size: var(--text-sm);">
                                <input type="checkbox" name="affection_missing" {% if 'missing_you' in (persona.affection_expressions or []) %}checked{% endif %}>
                                <span>Missing you</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: var(--space-2); cursor: pointer; font-size: var(--text-sm);">
                                <input type="checkbox" name="affection_future" {% if 'future_plans' in (persona.affection_expressions or []) %}checked{% endif %}>
                                <span>Future plans</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: var(--space-2); cursor: pointer; font-size: var(--text-sm);">
                                <input type="checkbox" name="affection_vulnerability" {% if 'vulnerability' in (persona.affection_expressions or []) %}checked{% endif %}>
                                <span>Vulnerability</span>
                            </label>
                        </div>
                        <span class="form-hint">Select behaviors to include in relationship dynamics</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Prompt -->
        <div class="form-card">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-4);">
                <h3 class="form-section-title" style="margin-bottom: 0; border-bottom: none; padding-bottom: 0;">Instructions</h3>
                <button type="button" class="ai-suggest-btn" id="suggest-system-prompt-btn">
                    <i data-lucide="sparkles" style="width: 14px; height: 14px;"></i>
                    AI Generate
                </button>
            </div>

            <div class="form-group">
                <textarea class="form-input" id="system_prompt" name="system_prompt" rows="6" required
                          placeholder="Instructions that guide the AI's behavior...">{{ persona.system_prompt or '' }}</textarea>
                <span class="form-hint">Direct instructions for how the AI should behave and respond</span>
            </div>
        </div>

        <!-- Communication Style (Simplified 3-level controls) -->
        <div class="form-card">
            <div class="collapsible-header" id="style-toggle" onclick="toggleStyleSettings()">
                <div style="display: flex; align-items: center; gap: var(--space-2);">
                    <h3 class="form-section-title" style="margin: 0; border: none; padding: 0;">
                        Communication Style
                    </h3>
                    <span class="changes-badge" id="style-changes-badge"></span>
                </div>
                <i data-lucide="chevron-down" class="collapsible-icon"></i>
            </div>

            <div class="collapsible-content" id="style-content">
                <p style="color: var(--text-muted); font-size: var(--text-sm); margin-bottom: var(--space-4);">
                    Adjust how this persona communicates. Only changes from the category defaults affect the AI.
                </p>

                <div class="style-controls" id="style-controls">
                    <!-- Warmth -->
                    <div class="style-group">
                        <div class="style-header">
                            <span class="style-label">Warmth</span>
                            <span class="style-changed" id="warmth-changed">Changed</span>
                        </div>
                        <div class="segmented-control" data-style="warmth">
                            <button type="button" class="segment-btn" data-value="cold">Cold</button>
                            <button type="button" class="segment-btn" data-value="neutral">Neutral</button>
                            <button type="button" class="segment-btn" data-value="warm">Warm</button>
                        </div>
                    </div>

                    <!-- Formality -->
                    <div class="style-group">
                        <div class="style-header">
                            <span class="style-label">Formality</span>
                            <span class="style-changed" id="formality-changed">Changed</span>
                        </div>
                        <div class="segmented-control" data-style="formality">
                            <button type="button" class="segment-btn" data-value="casual">Casual</button>
                            <button type="button" class="segment-btn" data-value="neutral">Neutral</button>
                            <button type="button" class="segment-btn" data-value="formal">Formal</button>
                        </div>
                    </div>

                    <!-- Directness -->
                    <div class="style-group">
                        <div class="style-header">
                            <span class="style-label">Directness</span>
                            <span class="style-changed" id="directness-changed">Changed</span>
                        </div>
                        <div class="segmented-control" data-style="directness">
                            <button type="button" class="segment-btn" data-value="gentle">Gentle</button>
                            <button type="button" class="segment-btn" data-value="balanced">Balanced</button>
                            <button type="button" class="segment-btn" data-value="direct">Direct</button>
                        </div>
                    </div>

                    <!-- Humor -->
                    <div class="style-group">
                        <div class="style-header">
                            <span class="style-label">Humor</span>
                            <span class="style-changed" id="humor-changed">Changed</span>
                        </div>
                        <div class="segmented-control" data-style="humor">
                            <button type="button" class="segment-btn" data-value="minimal">Minimal</button>
                            <button type="button" class="segment-btn" data-value="moderate">Moderate</button>
                            <button type="button" class="segment-btn" data-value="playful">Playful</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Model Configuration -->
        <div class="form-card">
            <div class="collapsible-header" id="model-toggle" onclick="toggleModelSettings()">
                <h3 class="form-section-title" style="margin: 0; border: none; padding: 0;">
                    Model Configuration
                </h3>
                <i data-lucide="chevron-down" class="collapsible-icon"></i>
            </div>

            <div class="collapsible-content" id="model-content">
                <div class="form-row">
                    <div class="form-group">
                        <label for="model" class="form-label">Model</label>
                        <select class="form-input" id="model" name="model">
                            <option value="">Loading models...</option>
                        </select>
                        <span class="form-hint">AI model to use for this persona</span>
                    </div>

                    <div class="form-group">
                        <div class="slider-header">
                            <label class="slider-label">Temperature</label>
                            <span class="slider-value" id="temperature_value">{{ persona.model_config.temperature if persona.model_config and persona.model_config.temperature else 0.7 }}</span>
                        </div>
                        <input type="range" min="0" max="2" step="0.1"
                               name="temperature" id="temperature"
                               value="{{ persona.model_config.temperature if persona.model_config and persona.model_config.temperature else 0.7 }}">
                        <span class="form-hint">Lower = more focused, Higher = more creative</span>
                    </div>
                </div>

                <!-- Advanced Sampler Settings -->
                <div class="collapsible-header" id="advanced-toggle" onclick="toggleAdvancedSettings()" style="margin-top: var(--space-4);">
                    <h4 class="form-section-title" style="margin: 0; border: none; padding: 0; font-size: var(--text-sm);">
                        Advanced Sampler Settings
                    </h4>
                    <i data-lucide="chevron-down" class="collapsible-icon"></i>
                </div>

                <div class="collapsible-content" id="advanced-content">
                    <div class="form-row">
                        <div class="form-group">
                            <div class="slider-header">
                                <label class="slider-label">
                                    Top-P (Nucleus Sampling)
                                    <span class="provider-badge all">All</span>
                                </label>
                                <span class="slider-value" id="top_p_value">{{ persona.model_config.top_p if persona.model_config and persona.model_config.top_p else 0.9 }}</span>
                            </div>
                            <input type="range" min="0" max="1" step="0.05"
                                   name="top_p" id="top_p"
                                   value="{{ persona.model_config.top_p if persona.model_config and persona.model_config.top_p else 0.9 }}">
                            <span class="form-hint">Probability mass for token sampling</span>
                        </div>

                        <div class="form-group">
                            <div class="slider-header">
                                <label class="slider-label">
                                    Top-K
                                    <span class="provider-badge ollama">Ollama</span>
                                </label>
                                <span class="slider-value" id="top_k_value">{{ persona.model_config.top_k if persona.model_config and persona.model_config.top_k else 40 }}</span>
                            </div>
                            <input type="range" min="1" max="100" step="1"
                                   name="top_k" id="top_k"
                                   value="{{ persona.model_config.top_k if persona.model_config and persona.model_config.top_k else 40 }}">
                            <span class="form-hint">Number of top tokens to consider</span>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <div class="slider-header">
                                <label class="slider-label">
                                    Repeat Penalty
                                    <span class="provider-badge ollama">Ollama</span>
                                </label>
                                <span class="slider-value" id="repeat_penalty_value">{{ persona.model_config.repeat_penalty if persona.model_config and persona.model_config.repeat_penalty else 1.1 }}</span>
                            </div>
                            <input type="range" min="0.5" max="2" step="0.05"
                                   name="repeat_penalty" id="repeat_penalty"
                                   value="{{ persona.model_config.repeat_penalty if persona.model_config and persona.model_config.repeat_penalty else 1.1 }}">
                            <span class="form-hint">Penalty for repeating tokens (1.0 = no penalty)</span>
                        </div>

                        <div class="form-group">
                            <div class="slider-header">
                                <label class="slider-label">
                                    Max Tokens
                                    <span class="provider-badge all">All</span>
                                </label>
                                <span class="slider-value" id="max_tokens_value">{{ persona.model_config.max_tokens if persona.model_config and persona.model_config.max_tokens else 2048 }}</span>
                            </div>
                            <input type="range" min="256" max="8192" step="256"
                                   name="max_tokens" id="max_tokens"
                                   value="{{ persona.model_config.max_tokens if persona.model_config and persona.model_config.max_tokens else 2048 }}">
                            <span class="form-hint">Maximum response length</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% if persona.id %}
        <!-- Setting & Memory (Simplified Context System) -->
        <div class="form-card">
            <div class="collapsible-header" id="knowledge-toggle" onclick="toggleKnowledgeSettings()">
                <h3 class="form-section-title" style="margin: 0; border: none; padding: 0;">
                    Setting & Memory
                </h3>
                <i data-lucide="chevron-down" class="collapsible-icon"></i>
            </div>

            <div class="collapsible-content" id="knowledge-content">
                <p style="color: var(--text-muted); font-size: var(--text-sm); margin-bottom: var(--space-4);">
                    Tell {{ persona.name or 'this persona' }} about yourself, configure the world setting, and manage memory. Context is automatically retrieved during conversations.
                </p>

                <div class="tabs-container">
                    <div class="tab-nav">
                        <button type="button" class="tab-btn active" data-tab="about-you">
                            <i data-lucide="user" style="width: 14px; height: 14px; margin-right: 4px;"></i>
                            About You
                        </button>
                        <button type="button" class="tab-btn" data-tab="setting">
                            <i data-lucide="globe" style="width: 14px; height: 14px; margin-right: 4px;"></i>
                            Setting
                        </button>
                        <button type="button" class="tab-btn" data-tab="memory">
                            <i data-lucide="brain" style="width: 14px; height: 14px; margin-right: 4px;"></i>
                            Memory
                        </button>
                    </div>

                    <!-- About You Tab (User Profile) -->
                    <div class="tab-content active" id="tab-about-you">
                        <p class="form-hint" style="margin-bottom: var(--space-4);">
                            Help {{ persona.name or 'this persona' }} know who they're talking to. This makes conversations more personal from the start.
                        </p>

                        <div class="form-group">
                            <label for="user-preferred-name" class="form-label">What should I call you?</label>
                            <input type="text" class="form-input" id="user-preferred-name"
                                   placeholder="Enter your preferred name" style="max-width: 300px;">
                            <span class="form-hint">A single name or nickname (e.g., "Jason" or "Dr. Smith")</span>
                        </div>

                        <div class="form-group">
                            <label for="user-intro" class="form-label">A bit about yourself <span style="color: var(--text-muted); font-weight: normal;">(optional)</span></label>
                            <textarea class="form-input" id="user-intro" rows="3"
                                      placeholder="e.g., I'm a software engineer interested in AI, or I'm a teacher looking for creative lesson ideas..."></textarea>
                            <span class="form-hint">Brief context helps the AI give more relevant responses</span>
                        </div>

                        <div class="collapsible-header" id="user-profile-toggle" onclick="toggleUserProfileAdvanced()">
                            <span style="font-size: var(--text-sm); color: var(--text-muted);">More options</span>
                            <i data-lucide="chevron-down" class="collapsible-icon"></i>
                        </div>

                        <div class="collapsible-content" id="user-profile-advanced">
                            <div class="form-group" style="margin-top: var(--space-4);">
                                <label class="form-label">How do you prefer feedback?</label>
                                <div class="segmented-control" data-style="user-feedback-style" style="max-width: 400px;">
                                    <button type="button" class="segment-btn" data-value="supportive">Supportive</button>
                                    <button type="button" class="segment-btn active" data-value="balanced">Balanced</button>
                                    <button type="button" class="segment-btn" data-value="direct">Direct</button>
                                </div>
                                <span class="form-hint">Supportive = gentler suggestions, Direct = straight to the point</span>
                            </div>

                            <div class="form-group">
                                <label for="user-avoid-topics" class="form-label">Topics to avoid <span style="color: var(--text-muted); font-weight: normal;">(optional)</span></label>
                                <input type="text" class="form-input" id="user-avoid-topics"
                                       placeholder="e.g., politics, specific health topics, etc.">
                                <span class="form-hint">Subjects you'd prefer the AI not bring up</span>
                            </div>
                        </div>

                        <div style="display: flex; justify-content: flex-end; margin-top: var(--space-4); padding-top: var(--space-4); border-top: 1px solid var(--border-subtle);">
                            <button type="button" class="btn btn-primary" onclick="saveUserProfile()" id="save-user-profile-btn">
                                <i data-lucide="save" style="width: 16px; height: 16px;"></i>
                                Save Profile
                            </button>
                        </div>
                    </div>

                    <!-- Setting Tab -->
                    <div class="tab-content" id="tab-setting">
                        <div class="form-group">
                            <label class="form-label">World / Universe</label>
                            <input type="text" class="form-input" id="setting-world" placeholder="e.g., Modern day Earth, Fantasy realm, Star Wars universe">
                            <span class="form-hint">The fictional or real world this character exists in</span>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Location</label>
                                <input type="text" class="form-input" id="setting-location" placeholder="e.g., San Francisco, The Kingdom of Aldoria">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Time Period</label>
                                <input type="text" class="form-input" id="setting-time" placeholder="e.g., Present day, Year 2087, Medieval era">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Key Facts</label>
                            <span class="form-hint" style="display: block; margin-bottom: var(--space-2);">Important context like "Magic exists" or "User is a detective"</span>
                            <div id="key-facts-list" class="entry-list" style="margin-bottom: var(--space-2);">
                                <!-- Facts will be populated by JavaScript -->
                            </div>
                            <div style="display: flex; gap: var(--space-2);">
                                <input type="text" class="form-input" id="new-key-fact" placeholder="Add a key fact..." style="flex: 1;">
                                <button type="button" class="btn btn-secondary" onclick="addKeyFact()">
                                    <i data-lucide="plus" style="width: 16px; height: 16px;"></i>
                                    Add
                                </button>
                            </div>
                        </div>

                        <div style="display: flex; justify-content: flex-end; margin-top: var(--space-4);">
                            <button type="button" class="btn btn-primary" onclick="saveSetting()" id="save-setting-btn">
                                <i data-lucide="save" style="width: 16px; height: 16px;"></i>
                                Save Setting
                            </button>
                        </div>
                    </div>

                    <!-- Memory Tab -->
                    <div class="tab-content" id="tab-memory">
                        <!-- Backstory Section -->
                        <div class="memory-section" style="margin-bottom: var(--space-6);">
                            <h4 style="margin-bottom: var(--space-2); font-size: var(--text-sm); font-weight: var(--font-semibold);">Character Backstory</h4>
                            <p class="form-hint" style="margin-bottom: var(--space-3);">Enter backstory and lore. The system automatically retrieves relevant parts during conversation.</p>
                            <textarea class="form-input" id="backstory" rows="8" placeholder="Enter character history, relationships, important events, personality background..."></textarea>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: var(--space-2);">
                                <span id="backstory-status" class="form-hint"></span>
                                <button type="button" class="btn btn-primary" onclick="saveBackstory()" id="save-backstory-btn">
                                    <i data-lucide="save" style="width: 16px; height: 16px;"></i>
                                    Save Backstory
                                </button>
                            </div>
                        </div>

                        <!-- Learned Facts Section -->
                        <div class="memory-section">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-3);">
                                <div>
                                    <h4 style="margin-bottom: var(--space-1); font-size: var(--text-sm); font-weight: var(--font-semibold);">What I Remember About You</h4>
                                    <p class="form-hint">Facts learned from conversations or added manually. Edit or remove any.</p>
                                </div>
                                <button type="button" class="btn btn-secondary btn-sm" onclick="showAddFactModal()">
                                    <i data-lucide="plus" style="width: 14px; height: 14px;"></i>
                                    Add Memory
                                </button>
                            </div>
                            <div id="learned-facts-list" class="entry-list">
                                <div class="empty-state" id="no-facts">
                                    <i data-lucide="brain" style="width: 32px; height: 32px;"></i>
                                    <p>No memories yet</p>
                                    <p style="font-size: var(--text-xs);">Facts are learned from conversations automatically.<br>You can also add them manually using the button above.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Form Actions -->
        <div class="form-actions">
            <a href="/personas" class="btn btn-secondary">
                <i data-lucide="arrow-left" style="width: 16px; height: 16px;"></i>
                Cancel
            </a>
            <button type="submit" class="btn btn-primary" id="save-btn">
                <i data-lucide="save" style="width: 16px; height: 16px;"></i>
                Save Changes
            </button>
        </div>
    </form>
</div>

<!-- Warning Modals -->
<div class="modal-backdrop" id="warning-modal-backdrop"></div>
<div class="modal" id="warning-modal">
    <div class="modal-header">
        <h3 class="modal-title" id="warning-modal-title">Notice</h3>
        <button class="modal-close" onclick="closeWarningModal()">
            <svg viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
        </button>
    </div>
    <div class="modal-body">
        <p id="warning-modal-text"></p>
    </div>
    <div class="modal-footer">
        <button class="btn btn-primary" onclick="closeWarningModal()">I Understand</button>
    </div>
</div>

<!-- Add Memory Modal -->
<div class="modal-backdrop" id="add-fact-modal-backdrop" onclick="hideAddFactModal()"></div>
<div class="modal" id="add-fact-modal">
    <div class="modal-header">
        <h3 class="modal-title">Add Memory</h3>
        <button class="modal-close" onclick="hideAddFactModal()">
            <svg viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
        </button>
    </div>
    <div class="modal-body">
        <div class="form-group">
            <label class="form-label">What to remember</label>
            <input type="text" class="form-input" id="new-fact-value" placeholder="e.g., I have a golden retriever named Max">
            <p class="form-hint">Enter the fact or detail you want remembered.</p>
        </div>
        <div class="form-group">
            <label class="form-label">Label</label>
            <input type="text" class="form-input" id="new-fact-key" placeholder="e.g., pet_name">
            <p class="form-hint">A short identifier for this memory (snake_case recommended).</p>
        </div>
        <div class="form-group">
            <label class="form-label">Category</label>
            <select class="form-select" id="new-fact-type">
                <option value="preference">Preference</option>
                <option value="name">Name</option>
                <option value="relationship">Relationship</option>
                <option value="location">Location</option>
                <option value="occupation">Occupation</option>
                <option value="hobby">Hobby</option>
                <option value="goal">Goal</option>
                <option value="trait">Trait</option>
                <option value="event">Event</option>
                <option value="other">Other</option>
            </select>
        </div>
    </div>
    <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideAddFactModal()">Cancel</button>
        <button class="btn btn-primary" onclick="createFact()" id="create-fact-btn">
            <i data-lucide="plus" style="width: 16px; height: 16px;"></i>
            Add Memory
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Category defaults for style overrides
    const CATEGORY_DEFAULTS = {
        "Coach": { warmth: "neutral", formality: "formal", directness: "direct", humor: "minimal" },
        "Assistant": { warmth: "neutral", formality: "formal", directness: "balanced", humor: "minimal" },
        "Friend": { warmth: "warm", formality: "casual", directness: "balanced", humor: "moderate" },
        "Teacher": { warmth: "warm", formality: "neutral", directness: "balanced", humor: "moderate" },
        "Advisor": { warmth: "neutral", formality: "formal", directness: "direct", humor: "minimal" },
        "Companion": { warmth: "warm", formality: "casual", directness: "gentle", humor: "playful" },
        "Roleplay": { warmth: "neutral", formality: "neutral", directness: "balanced", humor: "moderate" },
        "Creative": { warmth: "warm", formality: "casual", directness: "gentle", humor: "playful" },
        "Other": { warmth: "neutral", formality: "neutral", directness: "balanced", humor: "moderate" }
    };

    // Current style values
    let currentStyles = {
        warmth: "neutral",
        formality: "neutral",
        directness: "balanced",
        humor: "moderate"
    };

    // Initialize from persona data
    const initialCategory = '{{ persona.category or "Other" }}';
    const initialCommStyle = JSON.parse('{{ (persona.communication_style or {}) | tojson | safe }}');

    // Convert legacy 0-10 slider values to 3-level scale
    function convertLegacyValue(value, dimension) {
        if (typeof value === 'string') return value;
        if (typeof value !== 'number') return null;

        const v = Math.round(value * 10);
        const mappings = {
            warmth: { low: 'cold', mid: 'neutral', high: 'warm' },
            formality: { low: 'casual', mid: 'neutral', high: 'formal' },
            directness: { low: 'gentle', mid: 'balanced', high: 'direct' },
            humor: { low: 'minimal', mid: 'moderate', high: 'playful' }
        };

        const map = mappings[dimension];
        if (!map) return null;

        if (v <= 3) return map.low;
        if (v <= 6) return map.mid;
        return map.high;
    }

    // Initialize styles from existing data or defaults
    function initializeStyles() {
        const defaults = CATEGORY_DEFAULTS[initialCategory] || CATEGORY_DEFAULTS['Other'];

        ['warmth', 'formality', 'directness', 'humor'].forEach(dim => {
            let value = null;

            // Check for new 3-level value first
            if (initialCommStyle[dim] && typeof initialCommStyle[dim] === 'string') {
                value = initialCommStyle[dim];
            }
            // Check for legacy mapping (Warmth -> warmth, Directness -> directness, etc.)
            else if (initialCommStyle[dim.charAt(0).toUpperCase() + dim.slice(1)]) {
                value = convertLegacyValue(initialCommStyle[dim.charAt(0).toUpperCase() + dim.slice(1)], dim);
            }
            // Check for Formality specifically
            else if (dim === 'formality' && initialCommStyle['Formality']) {
                value = convertLegacyValue(initialCommStyle['Formality'], dim);
            }
            // Check for Humor specifically
            else if (dim === 'humor' && initialCommStyle['Humor']) {
                value = convertLegacyValue(initialCommStyle['Humor'], dim);
            }

            currentStyles[dim] = value || defaults[dim];
        });

        updateStyleUI();
    }

    // Update UI to reflect current styles
    function updateStyleUI() {
        const category = document.getElementById('category-select').value;
        const defaults = CATEGORY_DEFAULTS[category] || CATEGORY_DEFAULTS['Other'];
        let changedCount = 0;

        ['warmth', 'formality', 'directness', 'humor'].forEach(dim => {
            const control = document.querySelector(`.segmented-control[data-style="${dim}"]`);
            const changedIndicator = document.getElementById(`${dim}-changed`);

            if (control) {
                control.querySelectorAll('.segment-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.value === currentStyles[dim]);
                });
            }

            const isChanged = currentStyles[dim] !== defaults[dim];
            if (changedIndicator) {
                changedIndicator.classList.toggle('show', isChanged);
            }
            if (isChanged) changedCount++;
        });

        // Update badge
        const badge = document.getElementById('style-changes-badge');
        if (badge) {
            badge.textContent = changedCount > 0 ? `${changedCount} changed` : '';
        }
    }

    // Set initial category
    const categorySelect = document.getElementById('category-select');
    categorySelect.value = initialCategory in CATEGORY_DEFAULTS ? initialCategory : 'Other';

    // Category change handler - reset to defaults
    categorySelect.addEventListener('change', function() {
        const defaults = CATEGORY_DEFAULTS[this.value] || CATEGORY_DEFAULTS['Other'];
        currentStyles = { ...defaults };
        updateStyleUI();
    });

    // Style button click handlers
    document.querySelectorAll('.segmented-control').forEach(control => {
        control.querySelectorAll('.segment-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const style = control.dataset.style;
                const value = this.dataset.value;
                currentStyles[style] = value;
                updateStyleUI();
            });
        });
    });

    // Initialize styles
    initializeStyles();

    // Collapsible toggles
    function toggleStyleSettings() {
        const header = document.getElementById('style-toggle');
        const content = document.getElementById('style-content');
        header.classList.toggle('open');
        content.classList.toggle('open');
    }

    function toggleModelSettings() {
        const header = document.getElementById('model-toggle');
        const content = document.getElementById('model-content');
        header.classList.toggle('open');
        content.classList.toggle('open');
    }

    function toggleAdvancedSettings() {
        const header = document.getElementById('advanced-toggle');
        const content = document.getElementById('advanced-content');
        header.classList.toggle('open');
        content.classList.toggle('open');
    }

    function toggleKnowledgeSettings() {
        const header = document.getElementById('knowledge-toggle');
        const content = document.getElementById('knowledge-content');
        header.classList.toggle('open');
        content.classList.toggle('open');
    }

    function toggleUserProfileAdvanced() {
        const header = document.getElementById('user-profile-toggle');
        const content = document.getElementById('user-profile-advanced');
        header.classList.toggle('open');
        content.classList.toggle('open');
    }

    // Companion Mode functions
    function toggleCompanionSettings() {
        const content = document.getElementById('companion-content');
        const icon = document.getElementById('companion-icon');
        if (content.style.display === 'none') {
            content.style.display = 'block';
            icon.style.transform = 'rotate(180deg)';
        } else {
            content.style.display = 'none';
            icon.style.transform = 'rotate(0deg)';
        }
    }

    function toggleCompanionOptions() {
        const checkbox = document.getElementById('companion-mode');
        const options = document.getElementById('companion-options');
        options.style.display = checkbox.checked ? 'block' : 'none';
    }

    function updateCompanionSectionVisibility() {
        const category = document.getElementById('category-select').value;
        const section = document.getElementById('companion-mode-section');
        const companionCategories = ['Friend', 'Companion', 'Roleplay', 'Creative'];
        section.style.display = companionCategories.includes(category) ? 'block' : 'none';
    }

    // Initialize companion mode on page load
    updateCompanionSectionVisibility();
    toggleCompanionOptions();

    // Update companion visibility when category changes
    categorySelect.addEventListener('change', updateCompanionSectionVisibility);

    // User Profile (About You) Management
    let currentUserProfile = {
        preferred_name: '',
        brief_intro: '',
        feedback_style: 'balanced',
        topics_to_avoid: ''
    };

    // Initialize feedback style segmented control
    function initUserProfileControls() {
        const feedbackControl = document.querySelector('.segmented-control[data-style="user-feedback-style"]');
        if (feedbackControl) {
            feedbackControl.querySelectorAll('.segment-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    feedbackControl.querySelectorAll('.segment-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentUserProfile.feedback_style = this.dataset.value;
                });
            });
        }
    }

    // Load user profile
    async function loadUserProfile() {
        if (!PERSONA_ID) return;

        try {
            const resp = await fetch(`/api/characters/${PERSONA_ID}/user-profile`);
            if (!resp.ok) {
                // Profile doesn't exist yet, that's OK
                if (resp.status === 404) return;
                throw new Error('Failed to load user profile');
            }

            const data = await resp.json();
            currentUserProfile = data.user_profile || currentUserProfile;

            // Populate form fields
            document.getElementById('user-preferred-name').value = currentUserProfile.preferred_name || '';
            document.getElementById('user-intro').value = currentUserProfile.brief_intro || '';
            document.getElementById('user-avoid-topics').value = currentUserProfile.topics_to_avoid || '';

            // Set feedback style
            const feedbackControl = document.querySelector('.segmented-control[data-style="user-feedback-style"]');
            if (feedbackControl) {
                feedbackControl.querySelectorAll('.segment-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.value === (currentUserProfile.feedback_style || 'balanced'));
                });
            }
        } catch (e) {
            console.error('Error loading user profile:', e);
        }
    }

    // Save user profile
    async function saveUserProfile() {
        const btn = document.getElementById('save-user-profile-btn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner spinner-sm"></span> Saving...';

        const data = {
            preferred_name: document.getElementById('user-preferred-name').value.trim(),
            brief_intro: document.getElementById('user-intro').value.trim(),
            feedback_style: currentUserProfile.feedback_style || 'balanced',
            topics_to_avoid: document.getElementById('user-avoid-topics').value.trim()
        };

        try {
            const resp = await fetch(`/api/characters/${PERSONA_ID}/user-profile`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (!resp.ok) {
                const errorData = await resp.json().catch(() => ({}));
                throw new Error(errorData.detail || 'Failed to save profile');
            }

            showToast('Profile saved! ' + (data.preferred_name ? `${data.preferred_name}, nice to meet you!` : ''), 'success');
            currentUserProfile = data;
        } catch (e) {
            showToast('Error: ' + e.message, 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i data-lucide="save" style="width: 16px; height: 16px;"></i> Save Profile';
            lucide.createIcons();
        }
    }

    // Warning modal functions
    function showWarning(title, text) {
        document.getElementById('warning-modal-title').textContent = title;
        document.getElementById('warning-modal-text').textContent = text;
        document.getElementById('warning-modal-backdrop').classList.add('show');
        document.getElementById('warning-modal').classList.add('show');
        document.body.style.overflow = 'hidden';
    }

    function closeWarningModal() {
        document.getElementById('warning-modal-backdrop').classList.remove('show');
        document.getElementById('warning-modal').classList.remove('show');
        document.body.style.overflow = '';
    }

    document.getElementById('warning-modal-backdrop').onclick = closeWarningModal;

    // Temperature slider
    document.getElementById('temperature').addEventListener('input', function() {
        document.getElementById('temperature_value').textContent = this.value;
    });

    // Advanced sampler sliders
    ['top_p', 'top_k', 'repeat_penalty', 'max_tokens'].forEach(param => {
        const slider = document.getElementById(param);
        const display = document.getElementById(`${param}_value`);
        if (slider && display) {
            slider.addEventListener('input', function() {
                display.textContent = this.value;
            });
        }
    });

    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const tabId = this.dataset.tab;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.add('active');
        });
    });

    // Position option selection
    document.querySelectorAll('.position-option').forEach(opt => {
        opt.addEventListener('click', function() {
            this.parentElement.querySelectorAll('.position-option').forEach(o => o.classList.remove('selected'));
            this.classList.add('selected');
        });
    });

    // Simplified Context System functions
    const PERSONA_ID = '{{ persona.id or "" }}';

    // Current setting data
    let currentSetting = {
        world: '',
        location: '',
        time_period: '',
        key_facts: []
    };

    // Load setting data
    async function loadSetting() {
        if (!PERSONA_ID) return;

        try {
            const resp = await fetch(`/api/characters/${PERSONA_ID}/setting`);
            if (!resp.ok) throw new Error('Failed to load setting');

            const data = await resp.json();
            currentSetting = data.setting || { world: '', location: '', time_period: '', key_facts: [] };

            // Populate form fields
            document.getElementById('setting-world').value = currentSetting.world || '';
            document.getElementById('setting-location').value = currentSetting.location || '';
            document.getElementById('setting-time').value = currentSetting.time_period || '';

            renderKeyFacts();
        } catch (e) {
            console.error('Error loading setting:', e);
        }
    }

    // Render key facts list
    function renderKeyFacts() {
        const list = document.getElementById('key-facts-list');
        if (!list) return;

        const facts = currentSetting.key_facts || [];

        if (facts.length === 0) {
            list.innerHTML = '<p class="form-hint" style="padding: var(--space-2);">No key facts yet. Add important context above.</p>';
        } else {
            list.innerHTML = facts.map((fact, index) => `
                <div class="entry-item" style="padding: var(--space-2);">
                    <span style="flex: 1;">${escapeHtml(fact)}</span>
                    <button type="button" class="btn-icon-sm danger" onclick="removeKeyFact(${index})" title="Remove">
                        <i data-lucide="x" style="width: 14px; height: 14px;"></i>
                    </button>
                </div>
            `).join('');
        }

        lucide.createIcons();
    }

    // Add key fact
    function addKeyFact() {
        const input = document.getElementById('new-key-fact');
        const fact = input.value.trim();

        if (!fact) {
            showToast('Please enter a fact', 'error');
            return;
        }

        currentSetting.key_facts = currentSetting.key_facts || [];
        currentSetting.key_facts.push(fact);
        input.value = '';

        renderKeyFacts();
    }

    // Remove key fact
    function removeKeyFact(index) {
        currentSetting.key_facts.splice(index, 1);
        renderKeyFacts();
    }

    // Save setting
    async function saveSetting() {
        const btn = document.getElementById('save-setting-btn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner spinner-sm"></span> Saving...';

        const data = {
            world: document.getElementById('setting-world').value.trim(),
            location: document.getElementById('setting-location').value.trim(),
            time_period: document.getElementById('setting-time').value.trim(),
            key_facts: currentSetting.key_facts || []
        };

        try {
            const resp = await fetch(`/api/characters/${PERSONA_ID}/setting`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (!resp.ok) {
                const errorData = await resp.json().catch(() => ({}));
                throw new Error(errorData.detail || 'Failed to save setting');
            }

            showToast('Setting saved successfully', 'success');
            currentSetting = data;
        } catch (e) {
            showToast('Error: ' + e.message, 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i data-lucide="save" style="width: 16px; height: 16px;"></i> Save Setting';
            lucide.createIcons();
        }
    }

    // Load backstory
    async function loadBackstory() {
        if (!PERSONA_ID) return;

        try {
            const resp = await fetch(`/api/characters/${PERSONA_ID}/backstory`);
            if (!resp.ok) throw new Error('Failed to load backstory');

            const data = await resp.json();
            document.getElementById('backstory').value = data.backstory || '';

            const status = document.getElementById('backstory-status');
            if (data.stats && data.stats.chunk_count > 0) {
                status.textContent = `${data.stats.chunk_count} chunks indexed, ${data.stats.total_words} words`;
            } else {
                status.textContent = '';
            }
        } catch (e) {
            console.error('Error loading backstory:', e);
        }
    }

    // Save backstory
    async function saveBackstory() {
        const btn = document.getElementById('save-backstory-btn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner spinner-sm"></span> Saving...';

        const backstory = document.getElementById('backstory').value;

        try {
            const resp = await fetch(`/api/characters/${PERSONA_ID}/backstory`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ backstory: backstory })
            });

            if (!resp.ok) {
                const errorData = await resp.json().catch(() => ({}));
                throw new Error(errorData.detail || 'Failed to save backstory');
            }

            const data = await resp.json();
            showToast(data.message || 'Backstory saved', 'success');

            const status = document.getElementById('backstory-status');
            if (data.stats && data.stats.chunk_count > 0) {
                status.textContent = `${data.stats.chunk_count} chunks indexed, ${data.stats.total_words} words`;
            } else {
                status.textContent = 'Backstory cleared';
            }
        } catch (e) {
            showToast('Error: ' + e.message, 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i data-lucide="save" style="width: 16px; height: 16px;"></i> Save Backstory';
            lucide.createIcons();
        }
    }

    // Load learned facts
    async function loadLearnedFacts() {
        if (!PERSONA_ID) return;

        const list = document.getElementById('learned-facts-list');
        if (!list) return;

        try {
            const resp = await fetch(`/api/facts?character_id=${PERSONA_ID}`);
            if (!resp.ok) throw new Error('Failed to load facts');

            const data = await resp.json();
            const facts = data.facts || [];

            if (facts.length === 0) {
                list.innerHTML = `
                    <div class="empty-state" id="no-facts">
                        <i data-lucide="brain" style="width: 32px; height: 32px;"></i>
                        <p>No facts learned yet</p>
                        <p style="font-size: var(--text-xs);">Have some conversations and the system will remember important details!</p>
                    </div>
                `;
            } else {
                list.innerHTML = facts.map(fact => `
                    <div class="entry-item" id="fact-${fact.id}">
                        <div class="entry-info" style="flex: 1;">
                            <div class="fact-value-display" data-fact-id="${fact.id}" style="font-size: var(--text-base); font-weight: var(--font-medium); color: var(--text-primary); margin-bottom: var(--space-1);">
                                ${escapeHtml(fact.fact_value)}
                            </div>
                            <div class="entry-meta" style="display: flex; align-items: center; gap: var(--space-2);">
                                <span style="color: var(--text-muted);">${formatFactKey(fact.fact_key)}</span>
                                <span style="color: var(--text-muted); opacity: 0.5;">â€¢</span>
                                <span style="color: var(--text-muted); font-size: var(--text-xs);">${fact.fact_type}</span>
                                ${fact.is_global ? '<span class="keyword-tag">Global</span>' : ''}
                            </div>
                            <div class="fact-value-edit" data-fact-id="${fact.id}" style="display: none; margin-top: var(--space-2);">
                                <input type="text" class="form-input form-input-sm" value="${escapeHtml(fact.fact_value)}" style="margin-bottom: var(--space-2);">
                                <div style="display: flex; gap: var(--space-2);">
                                    <button type="button" class="btn btn-primary btn-sm" onclick="saveFact(${fact.id})">Save</button>
                                    <button type="button" class="btn btn-secondary btn-sm" onclick="cancelEditFact(${fact.id})">Cancel</button>
                                </div>
                            </div>
                        </div>
                        <div class="entry-actions">
                            <button type="button" class="btn-icon-sm" onclick="editFact(${fact.id})" title="Edit" data-edit-btn="${fact.id}">
                                <i data-lucide="pencil" style="width: 14px; height: 14px;"></i>
                            </button>
                            <button type="button" class="btn-icon-sm danger" onclick="deleteFact(${fact.id})" title="Remove">
                                <i data-lucide="trash-2" style="width: 14px; height: 14px;"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            lucide.createIcons();
        } catch (e) {
            console.error('Error loading learned facts:', e);
        }
    }

    // Edit fact - show inline editor
    function editFact(factId) {
        const display = document.querySelector(`.fact-value-display[data-fact-id="${factId}"]`);
        const edit = document.querySelector(`.fact-value-edit[data-fact-id="${factId}"]`);
        const editBtn = document.querySelector(`[data-edit-btn="${factId}"]`);

        if (display && edit) {
            display.style.display = 'none';
            edit.style.display = 'block';
            editBtn.style.display = 'none';
            // Focus the input
            edit.querySelector('input').focus();
        }
    }

    // Cancel edit fact
    function cancelEditFact(factId) {
        const display = document.querySelector(`.fact-value-display[data-fact-id="${factId}"]`);
        const edit = document.querySelector(`.fact-value-edit[data-fact-id="${factId}"]`);
        const editBtn = document.querySelector(`[data-edit-btn="${factId}"]`);

        if (display && edit) {
            display.style.display = 'block';
            edit.style.display = 'none';
            editBtn.style.display = '';
            // Reset the input value
            edit.querySelector('input').value = display.textContent.trim();
        }
    }

    // Save fact
    async function saveFact(factId) {
        const edit = document.querySelector(`.fact-value-edit[data-fact-id="${factId}"]`);
        const input = edit.querySelector('input');
        const newValue = input.value.trim();

        if (!newValue) {
            showToast('Value cannot be empty', 'error');
            return;
        }

        const saveBtn = edit.querySelector('.btn-primary');
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';

        try {
            const resp = await fetch(`/api/facts/${factId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ fact_value: newValue })
            });

            if (!resp.ok) {
                const errorData = await resp.json().catch(() => ({}));
                throw new Error(errorData.detail || 'Failed to save');
            }

            showToast('Fact updated', 'success');
            loadLearnedFacts();
        } catch (e) {
            showToast('Error: ' + e.message, 'error');
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save';
        }
    }

    // Delete fact
    async function deleteFact(factId) {
        if (!confirm('Remove this learned fact?')) return;

        try {
            const resp = await fetch(`/api/facts/${factId}`, { method: 'DELETE' });
            if (!resp.ok) throw new Error('Failed to delete');
            showToast('Fact removed', 'success');
            loadLearnedFacts();
        } catch (e) {
            showToast('Error: ' + e.message, 'error');
        }
    }

    // Escape HTML helper
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Format fact key from snake_case to readable format
    function formatFactKey(key) {
        if (!key) return '';
        return key
            .replace(/_/g, ' ')
            .replace(/\b\w/g, c => c.toUpperCase());
    }

    // === Add Memory Modal Functions ===

    function showAddFactModal() {
        document.getElementById('add-fact-modal-backdrop').classList.add('show');
        document.getElementById('add-fact-modal').classList.add('show');
        document.getElementById('new-fact-value').value = '';
        document.getElementById('new-fact-key').value = '';
        document.getElementById('new-fact-type').value = 'preference';
        document.getElementById('new-fact-value').focus();
        lucide.createIcons();
    }

    function hideAddFactModal() {
        document.getElementById('add-fact-modal-backdrop').classList.remove('show');
        document.getElementById('add-fact-modal').classList.remove('show');
    }

    async function createFact() {
        const factValue = document.getElementById('new-fact-value').value.trim();
        const factKey = document.getElementById('new-fact-key').value.trim();
        const factType = document.getElementById('new-fact-type').value;

        if (!factValue) {
            showToast('Please enter what to remember', 'error');
            return;
        }

        if (!factKey) {
            showToast('Please enter a label', 'error');
            return;
        }

        const btn = document.getElementById('create-fact-btn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner spinner-sm"></span> Adding...';

        try {
            const resp = await fetch('/api/facts', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    fact_type: factType,
                    fact_key: factKey,
                    fact_value: factValue,
                    character_id: PERSONA_ID
                })
            });

            if (!resp.ok) {
                const errorData = await resp.json().catch(() => ({}));
                throw new Error(errorData.detail || 'Failed to create memory');
            }

            showToast('Memory added successfully', 'success');
            hideAddFactModal();
            loadLearnedFacts();
        } catch (e) {
            showToast('Error: ' + e.message, 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i data-lucide="plus" style="width: 16px; height: 16px;"></i> Add Memory';
            lucide.createIcons();
        }
    }

    // Load data on page load
    if (PERSONA_ID) {
        loadSetting();
        loadBackstory();
        loadLearnedFacts();
        loadUserProfile();
    }

    // Initialize user profile controls
    initUserProfileControls();

    // Allow Enter key to add key fact
    document.getElementById('new-key-fact')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            addKeyFact();
        }
    });

    // Load available models
    async function loadAvailableModels() {
        try {
            const response = await fetch('/api/models?privacy_mode=cloud_allowed');
            if (!response.ok) throw new Error('Failed to load models');

            const availableModels = await response.json();
            const modelSelect = document.getElementById('model');
            const currentModel = '{{ persona.model_config.model if persona.model_config and persona.model_config.model else "" }}';

            modelSelect.innerHTML = '';
            let hasCurrentModel = false;

            Object.entries(availableModels).forEach(([provider, models]) => {
                if (models && models.length > 0) {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = provider.charAt(0).toUpperCase() + provider.slice(1);

                    models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = `${model}`;
                        option.dataset.provider = provider;
                        if (model === currentModel) {
                            option.selected = true;
                            hasCurrentModel = true;
                        }
                        optgroup.appendChild(option);
                    });

                    modelSelect.appendChild(optgroup);
                }
            });

            if (!hasCurrentModel && modelSelect.options.length > 0) {
                modelSelect.selectedIndex = 0;
            }
        } catch (error) {
            console.error('Error loading models:', error);
            const modelSelect = document.getElementById('model');
            modelSelect.innerHTML = `
                <option value="llama3.1:latest">llama3.1:latest</option>
                <option value="mistral:latest">mistral:latest</option>
            `;
        }
    }

    loadAvailableModels();

    // AI Suggest System Prompt
    document.getElementById('suggest-system-prompt-btn').addEventListener('click', async function() {
        const name = document.getElementById('name').value;
        const category = document.getElementById('category-select').value;
        const systemPrompt = document.getElementById('system_prompt').value;

        this.disabled = true;
        this.innerHTML = '<span class="spinner spinner-sm"></span> Generating...';

        try {
            const resp = await fetch('/api/suggest_system_prompt', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ backstory: '', category, system_prompt: systemPrompt, name })
            });

            if (!resp.ok) throw new Error('Failed to generate prompt');
            const data = await resp.json();
            document.getElementById('system_prompt').value = data.system_prompt;
            showToast('System prompt generated', 'success');
        } catch (e) {
            showToast('Error: ' + e.message, 'error');
        } finally {
            this.disabled = false;
            this.innerHTML = '<i data-lucide="sparkles" style="width: 14px; height: 14px;"></i> AI Generate';
            lucide.createIcons();
        }
    });

    // Form submission
    document.getElementById('persona-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const saveBtn = document.getElementById('save-btn');
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<span class="spinner spinner-sm"></span> Saving...';

        const formData = new FormData(this);

        // Get provider from model selection
        const modelSelect = document.getElementById('model');
        const selectedOption = modelSelect.options[modelSelect.selectedIndex];
        const provider = selectedOption?.dataset?.provider || 'ollama';

        // Build affection expressions array from checkboxes
        const affectionExpressions = [];
        if (document.querySelector('[name="affection_pet_names"]')?.checked) affectionExpressions.push('pet_names');
        if (document.querySelector('[name="affection_flirting"]')?.checked) affectionExpressions.push('flirting');
        if (document.querySelector('[name="affection_physical"]')?.checked) affectionExpressions.push('physical_affection');
        if (document.querySelector('[name="affection_missing"]')?.checked) affectionExpressions.push('missing_you');
        if (document.querySelector('[name="affection_future"]')?.checked) affectionExpressions.push('future_plans');
        if (document.querySelector('[name="affection_vulnerability"]')?.checked) affectionExpressions.push('vulnerability');

        const personaData = {
            name: formData.get('name'),
            category: formData.get('category'),
            hide_category: document.getElementById('hide-category').checked,
            system_prompt: formData.get('system_prompt'),
            communication_style: currentStyles,
            // Companion Mode settings
            companion_mode: document.getElementById('companion-mode')?.checked || false,
            intimacy_style: formData.get('intimacy_style') || 'romantic',
            connection_depth: formData.get('connection_depth') || 'meaningful',
            affection_expressions: affectionExpressions,
            llm_config: {
                provider: provider,
                model: formData.get('model'),
                temperature: parseFloat(formData.get('temperature')),
                top_p: parseFloat(formData.get('top_p')) || 0.9,
                top_k: parseInt(formData.get('top_k')) || 40,
                repeat_penalty: parseFloat(formData.get('repeat_penalty')) || 1.1,
                max_tokens: parseInt(formData.get('max_tokens')) || 2048
            }
        };

        try {
            const personaId = '{{ persona.id or "" }}';
            const url = personaId ? `/api/characters/${personaId}` : '/api/characters';
            const method = personaId ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(personaData)
            });

            if (response.ok) {
                showToast('Persona saved successfully', 'success');
                setTimeout(() => {
                    window.location.href = '/personas';
                }, 1000);
            } else {
                const error = await response.json();
                showToast('Error: ' + (error.error || 'Failed to save'), 'error');
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i data-lucide="save" style="width: 16px; height: 16px;"></i> Save Changes';
                lucide.createIcons();
            }
        } catch (err) {
            showToast('Error: ' + err.message, 'error');
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i data-lucide="save" style="width: 16px; height: 16px;"></i> Save Changes';
            lucide.createIcons();
        }
    });

    // ===========================================
    // Avatar Upload Functionality
    // ===========================================

    // Initialize avatar upload handlers
    function initAvatarUpload() {
        const uploadBtn = document.getElementById('upload-avatar-btn');
        const avatarInput = document.getElementById('avatar-input');
        const avatarPreview = document.getElementById('avatar-preview');
        const removeBtn = document.getElementById('remove-avatar-btn');
        const avatarStatus = document.getElementById('avatar-status');

        if (uploadBtn && avatarInput) {
            // Trigger file input when upload button is clicked
            uploadBtn.addEventListener('click', () => avatarInput.click());

            // Also trigger on preview click
            if (avatarPreview) {
                avatarPreview.addEventListener('click', () => avatarInput.click());
            }

            // Handle file selection
            avatarInput.addEventListener('change', async function() {
                const file = this.files[0];
                if (!file) return;

                // Validate file type
                if (!file.type.startsWith('image/')) {
                    showToast('Please select an image file', 'error');
                    return;
                }

                // Validate file size (5MB max)
                if (file.size > 5 * 1024 * 1024) {
                    showToast('Image must be less than 5MB', 'error');
                    return;
                }

                // Show uploading status
                uploadBtn.disabled = true;
                uploadBtn.innerHTML = '<span class="spinner spinner-sm"></span> Uploading...';
                if (avatarStatus) {
                    avatarStatus.style.display = 'inline';
                    avatarStatus.textContent = 'Uploading...';
                }

                try {
                    const formData = new FormData();
                    formData.append('file', file);

                    const response = await fetch(`/api/characters/${PERSONA_ID}/avatar`, {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const result = await response.json();

                        // Update preview with new avatar
                        avatarPreview.innerHTML = `<img src="${result.avatar_url}?t=${Date.now()}"
                            alt="Avatar" style="width: 100%; height: 100%; object-fit: cover;">`;

                        // Add remove button if not present
                        if (!document.getElementById('remove-avatar-btn')) {
                            const wrapper = avatarPreview.parentElement;
                            const newRemoveBtn = document.createElement('button');
                            newRemoveBtn.type = 'button';
                            newRemoveBtn.className = 'avatar-remove-btn';
                            newRemoveBtn.id = 'remove-avatar-btn';
                            newRemoveBtn.style.cssText = 'position: absolute; top: -8px; right: -8px; width: 24px; height: 24px; border-radius: 50%; background: var(--pop-danger); border: none; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; line-height: 1;';
                            newRemoveBtn.textContent = 'Ã—';
                            newRemoveBtn.addEventListener('click', handleAvatarRemove);
                            wrapper.appendChild(newRemoveBtn);
                        }

                        showToast('Avatar uploaded successfully', 'success');
                        if (avatarStatus) avatarStatus.style.display = 'none';
                    } else {
                        const error = await response.json();
                        showToast('Upload failed: ' + (error.detail || 'Unknown error'), 'error');
                    }
                } catch (err) {
                    console.error('Avatar upload error:', err);
                    showToast('Upload failed: ' + err.message, 'error');
                } finally {
                    uploadBtn.disabled = false;
                    uploadBtn.innerHTML = '<i data-lucide="upload" style="width: 14px; height: 14px; margin-right: var(--space-1);"></i> Upload Image';
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                    if (avatarStatus) avatarStatus.style.display = 'none';
                    avatarInput.value = ''; // Reset input
                }
            });
        }

        // Handle remove button click
        if (removeBtn) {
            removeBtn.addEventListener('click', handleAvatarRemove);
        }
    }

    // Remove avatar handler
    async function handleAvatarRemove(e) {
        e.stopPropagation();

        if (!confirm('Remove this avatar?')) return;

        try {
            const response = await fetch(`/api/characters/${PERSONA_ID}/avatar`, {
                method: 'DELETE'
            });

            if (response.ok) {
                const avatarPreview = document.getElementById('avatar-preview');
                avatarPreview.innerHTML = '<i data-lucide="user" style="width: 40px; height: 40px; color: var(--text-muted);"></i>';
                if (typeof lucide !== 'undefined') lucide.createIcons();

                // Remove the remove button
                const removeBtn = document.getElementById('remove-avatar-btn');
                if (removeBtn) removeBtn.remove();

                showToast('Avatar removed', 'success');
            } else {
                showToast('Failed to remove avatar', 'error');
            }
        } catch (err) {
            console.error('Avatar remove error:', err);
            showToast('Failed to remove avatar: ' + err.message, 'error');
        }
    }

    // Re-initialize icons
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
        // Initialize avatar upload handlers
        initAvatarUpload();
    });
</script>
{% endblock %}
